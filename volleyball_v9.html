<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VolleySim Pro+ (Lineups ‚Ä¢ Rotations ‚Ä¢ Match Sim)</title>
  <style>
    /* =========================
       Theme tokens (V5-inspired)
    ========================== */
    :root{
      --bg: #000000;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --subtle: rgba(255,255,255,.55);
      --border: rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --shadow2: 0 6px 16px rgba(0,0,0,.35);
      --btn: rgba(255,255,255,.10);
      --btnHover: rgba(255,255,255,.16);
      --btnActive: rgba(255,255,255,.22);
      --focus: 0 0 0 3px rgba(112,214,255,.35);
      --radius: 16px;
      --radius2: 12px;

      --accent: #70d6ff;
      --accent2:#8b5cf6;

      --good: #2dd4bf;
      --warn: #fbbf24;
      --bad: #fb7185;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";

      /* Team accents */
      --teamA: #ea580c; /* orange */
      --teamA2:#fdba74;
      --teamB: #dc2626; /* red */
      --teamB2:#fca5a5;

      /* Court */
      --court-wood: #2a1a0b;
      --court-wood2:#3a2410;
      --court-lines: rgba(255,255,255,.80);
      --net-dark: rgba(0,0,0,.65);
    }

    [data-theme="light"]{
      --bg: #f6f7fb;
      --panel: rgba(0,0,0,.04);
      --panel2: rgba(0,0,0,.055);
      --text: rgba(0,0,0,.88);
      --muted: rgba(0,0,0,.62);
      --subtle: rgba(0,0,0,.50);
      --border: rgba(0,0,0,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.10);
      --shadow2: 0 6px 16px rgba(0,0,0,.10);
      --btn: rgba(0,0,0,.06);
      --btnHover: rgba(0,0,0,.09);
      --btnActive: rgba(0,0,0,.12);
      --focus: 0 0 0 3px rgba(37, 99, 235, .22);

      --court-wood: #f5d18c;
      --court-wood2:#efc97b;
      --court-lines: rgba(255,255,255,.95);
      --net-dark: rgba(20,20,20,.75);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    html{background: var(--bg);}
    html[data-theme="dark"]{color-scheme: dark;}
    html[data-theme="light"]{color-scheme: light;}

    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background: var(--bg);
      position: relative;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    /* Fix iOS/Safari "tiled gradient seam" on long pages by
       painting the decorative gradients on a fixed layer. */
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      z-index: -1;
      pointer-events:none;
      background: var(--bg);
      background-repeat: no-repeat;
      background-size: cover;
      transform: translateZ(0);
      will-change: transform;
    }
    [data-theme="light"] body::before{
      background:
        radial-gradient(1200px 600px at 30% -10%, rgba(37, 99, 235,.18), transparent 55%),
        radial-gradient(900px 500px at 90% 0%, rgba(139,92,246,.14), transparent 55%),
        var(--bg);
      background-repeat: no-repeat;
      background-size: cover;
    }

    .app{min-height:100%; display:flex; flex-direction:column;}

    header{
      position:sticky; top:0;
      z-index:50;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      background: linear-gradient(to bottom, rgba(0,0,0,.28), rgba(0,0,0,.08));
      border-bottom: 1px solid var(--border);
    }
    [data-theme="light"] header{
      background: linear-gradient(to bottom, rgba(255,255,255,.75), rgba(255,255,255,.55));
    }

    .header-inner{
      max-width:1600px;
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 260px;
    }
    .brand h1{
      margin:0;
      font-size:15px;
      letter-spacing:.2px;
      font-weight:800;
      line-height:1.1;
    }
    .brand small{
      display:block;
      color: var(--muted);
      font-weight:600;
      margin-top:2px;
    }

    .vb{
      width:28px;height:28px; flex:0 0 auto;
      filter: drop-shadow(0 8px 14px rgba(0,0,0,.18));
    }

    .header-actions{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .segmented{
      display:inline-flex;
      background: var(--panel);
      border:1px solid var(--border);
      border-radius:999px;
      padding:4px;
      box-shadow: var(--shadow2);
    }
    .segmented button{
      border:0;
      background: transparent;
      color: var(--muted);
      padding:8px 12px;
      border-radius:999px;
      font-weight:800;
      cursor:pointer;
      display:flex;
      gap:8px;
      align-items:center;
      transition: background .18s ease, transform .06s ease, color .18s ease;
      user-select:none;
    }
    .segmented button[aria-selected="true"]{
      background: var(--panel2);
      color: var(--text);
    }
    .segmented button:hover{background: var(--btnHover); color: var(--text)}
    .segmented button:active{transform: translateY(1px)}
    .icon{width:18px;height:18px; display:inline-block; color: currentColor;}

    main{
      width:100%;
      max-width:1600px;
      margin:0 auto;
      padding:16px;
      flex:1;
    }

    .hidden{display:none !important;}

    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-header{
      padding:14px 14px 12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .card-header h2{
      margin:0;
      font-size:13px;
      letter-spacing:.2px;
      font-weight:900;
    }
    .card-header p{
      margin:4px 0 0 0;
      color: var(--muted);
      font-size:12px;
      font-weight:650;
    }
    .card-body{padding:14px;}

    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius: 12px;
      background: var(--btn);
      border: 1px solid var(--border);
      color: var(--text);
      cursor:pointer;
      font-weight:800;
      letter-spacing:.2px;
      transition: transform .06s ease, background .18s ease, box-shadow .18s ease, opacity .18s ease;
      user-select:none;
      line-height:1;
      white-space:nowrap;
    }
    .btn:hover{background: var(--btnHover)}
    .btn:active{transform: translateY(1px); background: var(--btnActive)}
    .btn:focus-visible{outline:none; box-shadow: var(--focus)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(112,214,255,.18), rgba(139,92,246,.18));
      border-color: rgba(112,214,255,.28);
    }
    .btn.primary:hover{
      background: linear-gradient(135deg, rgba(112,214,255,.24), rgba(139,92,246,.22));
    }
    .btn.danger{
      background: rgba(251, 113, 133, .12);
      border-color: rgba(251, 113, 133, .22);
    }
    .btn.danger:hover{background: rgba(251, 113, 133, .16)}
    .btn.ghost{background: transparent;}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none;}

    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background: var(--panel2);
      border: 1px solid var(--border);
      color: var(--muted);
      font-weight:800;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }

    label{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin-bottom:6px;
      font-weight:800;
    }
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.10);
      color: var(--text);
      outline:none;
      transition: box-shadow .18s ease, border-color .18s ease, background .18s ease;
      font-family: var(--sans);
    }

    /* Better native form control theming (fixes dark-mode white select menus on some browsers) */
    select{
      appearance:none;
      -webkit-appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, var(--muted) 50%),
        linear-gradient(135deg, var(--muted) 50%, transparent 50%);
      background-position:
        calc(100% - 18px) calc(50% - 2px),
        calc(100% - 12px) calc(50% - 2px);
      background-size: 6px 6px, 6px 6px;
      background-repeat:no-repeat;
      padding-right: 34px;
    }
    select::-ms-expand{display:none;}
    [data-theme="dark"] select option{
      background: #0b1220;
      color: rgba(255,255,255,.92);
    }
    [data-theme="light"] select option{
      background: #ffffff;
      color: rgba(0,0,0,.88);
    }

    /* Layout helpers for new tabs */
    .grid-home{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 1100px){
      .grid-home{grid-template-columns: 1fr;}
    }

    .grid-lineup{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 1100px){
      .grid-lineup{grid-template-columns: 1fr;}
    }

    .steps{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 900px){
      .steps{grid-template-columns: 1fr;}
    }
    .step{
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
    }
    [data-theme="light"] .step{background: rgba(0,0,0,.02)}
    .step b{display:block; font-size:12px; font-weight:950; margin-bottom:6px;}
    .step p{margin:0; font-size:12px; color: var(--muted); font-weight:750; line-height:1.45;}

    details{
      border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      padding:10px 12px;
    }
    [data-theme="light"] details{background: rgba(0,0,0,.02)}
    details + details{margin-top:10px;}
    summary{
      cursor:pointer;
      list-style:none;
      font-weight:950;
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    summary::-webkit-details-marker{display:none;}
    .summaryHint{
      font-size:11px;
      font-weight:900;
      color: var(--muted);
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background: var(--panel2);
      white-space:nowrap;
    }
    .ruleBody{
      margin-top:10px;
      color: var(--muted);
      font-size:12px;
      font-weight:750;
      line-height:1.5;
    }

    [data-theme="light"] input,
    [data-theme="light"] select,
    [data-theme="light"] textarea{
      background: rgba(255,255,255,.65);
    }
    input:focus, select:focus, textarea:focus{
      box-shadow: var(--focus);
      border-color: rgba(112,214,255,.35);
    }
    textarea{min-height:110px; resize:vertical; font-family: var(--mono); font-size:12px;}

    .grid-match{
      display:grid;
      grid-template-columns: 320px 1fr 320px;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 1100px){
      .grid-match{grid-template-columns: 1fr; }
    }

    /* =========================
       Team panels
    ========================== */
    .teamTitle{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .teamDot{
      width:10px;height:10px;border-radius:999px;display:inline-block;
      background: var(--accent);
    }
    .teamDot.a{background: var(--teamA)}
    .teamDot.b{background: var(--teamB)}

    .teamMeta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .fieldRow{
      display:grid;
      grid-template-columns: 1.4fr .9fr .9fr;
      gap:10px;
    }
    .fieldRow2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .hint{font-size:12px; color: var(--muted); margin-top:8px; font-weight:650;}
    .mono{font-family: var(--mono); font-size:12px; color: var(--muted);}

    .notice{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(251,191,36,.25);
      background: rgba(251,191,36,.12);
      color: rgba(251,191,36,.95);
      font-size:12px;
      font-weight:700;
      display:none;
      white-space:pre-line;
    }
    .notice.show{display:block;}

    .ok{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(45,212,191,.25);
      background: rgba(45,212,191,.12);
      color: rgba(45,212,191,.95);
      font-size:12px;
      font-weight:800;
      display:none;
    }
    .ok.show{display:block;}

    .roster{
      list-style:none;
      padding:0;
      margin:10px 0 0 0;
      max-height: 260px;
      overflow:auto;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
    }
    [data-theme="light"] .roster{background: rgba(0,0,0,.02);}
    .roster li{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      padding:10px 10px;
      border-bottom:1px solid var(--border);
    }
    .roster li:last-child{border-bottom:0}
    .rMain{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .rName{
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .rSub{
      color: var(--muted);
      font-weight:750;
      font-size:11px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tag{
      font-size:11px;
      padding:4px 7px;
      border-radius:999px;
      border:1px solid var(--border);
      background: var(--panel2);
      color: var(--muted);
      font-weight:900;
      white-space:nowrap;
    }
    .miniBtns{
      display:flex;
      gap:8px;
      align-items:center;
      flex:0 0 auto;
    }
    .miniBtn{
      border:1px solid var(--border);
      background: rgba(251, 113, 133, .12);
      color: var(--text);
      padding:7px 9px;
      border-radius: 10px;
      cursor:pointer;
      font-weight:900;
      transition: transform .06s ease, background .18s ease;
    }
    .miniBtn:hover{background: rgba(251, 113, 133, .18)}
    .miniBtn:active{transform: translateY(1px)}

    /* Lineup assignment */
    .lineupGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top:12px;
    }
    .slot{
      display:grid;
      grid-template-columns: 92px 1fr;
      gap:10px;
      align-items:center;
      padding:10px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
    }
    [data-theme="light"] .slot{background: rgba(0,0,0,.02)}
    .slot b{font-size:12px; font-weight:950;}
    .slot small{display:block; color: var(--muted); font-weight:800; margin-top:2px;}

    .rowBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    /* =========================
       Court panel
    ========================== */
    .scoreboard{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:14px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadow2);
    }
    [data-theme="light"] .scoreboard{
      background: rgba(255,255,255,.75);
    }
    .scoreSide{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-start;
      min-width: 120px;
    }
    .scoreSide.right{align-items:flex-end;}
    .teamLabel{
      display:flex;
      align-items:center;
      gap:8px;
      color: var(--muted);
      font-weight:900;
      font-size:12px;
    }
    .scoreNum{
      font-size:28px;
      font-weight:950;
      letter-spacing:.2px;
      line-height:1;
    }
    .scoreNum.a{color: var(--teamA2);}
    .scoreNum.b{color: var(--teamB2);}

    .centerStatus{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      min-width: 160px;
    }
    .vs{font-weight:950; letter-spacing:.2px;}
    .status{
      font-size:11px;
      color: var(--muted);
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:1px;
      text-align:center;
    }
    .servePill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: var(--panel2);
      color: var(--text);
      font-weight:900;
      display:inline-flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }

    .courtWrap{
      margin-top:14px;
      display:grid;
      gap:14px;
    }

    .court-container{
      position: relative;
      width: 100%;
      max-width: 520px;
      margin: 0 auto;
      /* Shorter court so it fits better without scrolling */
      height: clamp(320px, 50vh, 560px);
      border-radius: var(--radius);
      overflow:hidden;
      border:1px solid var(--border);
      box-shadow: var(--shadow2);
      background:
        radial-gradient(circle at 16px 16px, rgba(255,255,255,.10) 2px, transparent 2.1px) 0 0 / 32px 32px,
        linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.18)),
        linear-gradient(180deg, var(--court-wood), var(--court-wood2));
    }
    [data-theme="light"] .court-container{
      background:
        radial-gradient(circle at 16px 16px, rgba(0,0,0,.08) 2px, transparent 2.1px) 0 0 / 32px 32px,
        linear-gradient(180deg, rgba(255,255,255,.25), rgba(0,0,0,.02)),
        linear-gradient(180deg, var(--court-wood), var(--court-wood2));
    }

    .center-line{
      position: absolute; top: 50%; left: 0; width: 100%; height: 6px;
      background: var(--court-lines); transform: translateY(-50%); z-index: 5;
      opacity:.9;
    }
    .net{
      position: absolute; top: 50%; left: -5%; width: 110%; height: 12px;
      background: repeating-linear-gradient(90deg, var(--net-dark), var(--net-dark) 4px, rgba(255,255,255,.85) 4px, rgba(255,255,255,.85) 8px);
      transform: translateY(-50%); z-index: 15;
      box-shadow: 0 10px 10px rgba(0,0,0,0.30);
      opacity:.95;
    }
    .attack-line-top { position: absolute; top: 33.3%; left: 0; width: 100%; height: 3px; background: var(--court-lines); opacity: 0.55; }
    .attack-line-bot { position: absolute; top: 66.6%; left: 0; width: 100%; height: 3px; background: var(--court-lines); opacity: 0.55; }

    .zone-label{
      position:absolute;
      transform: translate(-50%, -50%);
      z-index: 3;
      pointer-events:none;
      opacity:.9;
    }
    .zoneChip{
      font-size:11px;
      padding:4px 7px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.28);
      background: rgba(0,0,0,.25);
      color: rgba(255,255,255,.90);
      font-weight:950;
      letter-spacing:.3px;
      box-shadow: 0 8px 14px rgba(0,0,0,.18);
    }
    [data-theme="light"] .zoneChip{
      background: rgba(255,255,255,.70);
      border:1px solid rgba(0,0,0,.12);
      color: rgba(0,0,0,.80);
    }

    .player-token{
      position: absolute;
      width: 58px; height: 58px;
      border-radius: 999px;
      border: 3px solid;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap:2px;
      transform: translate(-50%, -50%);
      z-index: 10;
      background: rgba(255,255,255,.92);
      color: #111827;
      box-shadow: 0 10px 18px rgba(0,0,0,0.30);
      transition: top 0.50s cubic-bezier(.2,.95,.2,1), left 0.50s cubic-bezier(.2,.95,.2,1), transform .22s ease, box-shadow .22s ease;
      text-align:center;
      padding:6px;
      user-select:none;
    }
    [data-theme="dark"] .player-token{
      background: rgba(255,255,255,.94);
    }
    .team-a-token{ border-color: var(--teamA); }
    .team-b-token{ border-color: var(--teamB); }

    .token-jersey{
      font-weight:950;
      font-size:14px;
      line-height:1;
    }
    .token-name{
      width: 100%;
      font-weight:900;
      font-size:10px;
      line-height:1.05;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .token-role{
      font-weight:950;
      font-size:9px;
      padding:3px 6px;
      border-radius:999px;
      border:1px solid rgba(112,214,255,.25);
      background: rgba(112,214,255,.14);
      color:#0f172a;
      display:none;
    }
    .tokenRoleOn .token-role{display:inline-flex;}

    .is-serving{
      outline: 3px solid rgba(112,214,255,.55);
      box-shadow: 0 16px 28px rgba(112,214,255,.18), 0 10px 18px rgba(0,0,0,.28);
      transform: translate(-50%, -50%) scale(1.05);
    }

    /* Ball */
    .game-ball{
      position: absolute;
      font-size: 1.9em;
      z-index: 25;
      transform: translate(-50%, -50%);
      opacity: 0;
      transition: top 0.35s linear, left 0.35s linear, transform 0.18s ease, opacity .18s ease;
      pointer-events:none;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.35));
    }
    .ball-active{opacity: 1;}
    .ball-smash{transform: translate(-50%, -50%) scale(1.55);}

    /* Controls under court */
    .controlsRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
    }
    .controlsLeft, .controlsRight{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tiny{
      font-size:12px;
      color: var(--muted);
      font-weight:800;
    }

    .toggle{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      background: var(--btn);
      border:1px solid var(--border);
      cursor:pointer;
      user-select:none;
      transition: background .18s ease, transform .06s ease;
    }
    .toggle:hover{background: var(--btnHover)}
    .toggle:active{transform: translateY(1px)}
    .toggle input{width:auto; margin:0}
    .toggle span{font-size:12px; font-weight:900; color: var(--muted)}

    .eventLog{
      margin-top:12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      padding:10px 12px;
    }
    [data-theme="light"] .eventLog{background: rgba(0,0,0,.02)}
    .eventLog h3{
      margin:0 0 8px 0;
      font-size:12px;
      font-weight:950;
      letter-spacing:.2px;
      color: var(--muted);
      text-transform:uppercase;
    }
    .events{
      margin:0;
      padding-left: 18px;
      color: var(--muted);
      font-size:12px;
      font-weight:750;
      line-height:1.45;
    }

    /* Save/load panel */
    .saveGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 900px){
      .saveGrid{grid-template-columns:1fr;}
    }

    /* Coach sheet */
    .coachTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .coachGrid{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
    }
    @media (max-width: 1100px){ .coachGrid{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 650px){ .coachGrid{grid-template-columns: 1fr;} }

    .miniRotation{
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      overflow:hidden;
    }
    [data-theme="light"] .miniRotation{background: rgba(0,0,0,.02)}
    .miniRotation .miniHead{
      padding:10px 10px 8px 10px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .miniRotation .miniHead b{
      font-size:12px;
      font-weight:950;
    }
    .miniRotation .miniHead small{
      color: var(--muted);
      font-weight:800;
      font-size:11px;
    }

    .miniCourt{
      padding:10px;
    }
    .miniGrid{
      width:100%;
      aspect-ratio: 3/2;
      border-radius: 12px;
      border:1px solid var(--border);
      overflow:hidden;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap:8px;
      padding:10px;
      background:
        radial-gradient(circle at 12px 12px, rgba(255,255,255,.08) 2px, transparent 2.1px) 0 0 / 24px 24px,
        linear-gradient(180deg, rgba(0,0,0,.06), rgba(0,0,0,.16)),
        rgba(255,255,255,.04);
    }
    [data-theme="light"] .miniGrid{
      background:
        radial-gradient(circle at 12px 12px, rgba(0,0,0,.07) 2px, transparent 2.1px) 0 0 / 24px 24px,
        linear-gradient(180deg, rgba(255,255,255,.35), rgba(0,0,0,.02)),
        rgba(0,0,0,.02);
    }

    .mZone{
      border-radius: 12px;
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      position:relative;
      overflow:hidden;
      padding:8px;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      gap:4px;
    }
    [data-theme="light"] .mZone{
      border: 1px dashed rgba(0,0,0,.14);
      background: rgba(0,0,0,.02);
    }
    .mLabel{
      position:absolute; top:7px; left:7px;
      font-size:11px;
      font-weight:950;
      color: var(--muted);
      display:flex;
      gap:6px;
      align-items:center;
    }
    .mLabel .chip{
      font-size:10px;
      padding:3px 6px;
      border-radius:999px;
      border:1px solid var(--border);
      background: var(--panel2);
      font-weight:950;
      color: var(--muted);
    }
    .mName{
      font-size:11px;
      font-weight:950;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .mRole{
      font-size:10px;
      font-weight:950;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .mServe{
      outline: 2px solid rgba(112,214,255,.55);
      box-shadow: 0 12px 22px rgba(112,214,255,.14);
    }


    /* =========================
       Lineup tab: court preview
    ========================== */
    .lineupCourt{
      position: relative;
      width: 100%;
      max-width: 520px;
      margin: 0 auto;
      border-radius: var(--radius);
      overflow: hidden;
      border:1px solid var(--border);
      box-shadow: var(--shadow2);
      background:
        radial-gradient(circle at 14px 14px, rgba(255,255,255,.10) 2px, transparent 2.1px) 0 0 / 28px 28px,
        linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.20)),
        linear-gradient(180deg, var(--court-wood), var(--court-wood2));
      padding: 12px;
    }
    [data-theme="light"] .lineupCourt{
      background:
        radial-gradient(circle at 14px 14px, rgba(0,0,0,.08) 2px, transparent 2.1px) 0 0 / 28px 28px,
        linear-gradient(180deg, rgba(255,255,255,.35), rgba(0,0,0,.02)),
        linear-gradient(180deg, var(--court-wood), var(--court-wood2));
    }
    .lineupCourt::before{
      content:"";
      position:absolute;
      left:12px; right:12px;
      top:12px;
      height: 8px;
      border-radius: 999px;
      background: repeating-linear-gradient(90deg, var(--net-dark), var(--net-dark) 4px, rgba(255,255,255,.85) 4px, rgba(255,255,255,.85) 8px);
      opacity:.95;
      box-shadow: 0 10px 10px rgba(0,0,0,0.25);
      pointer-events:none;
    }
    .lineupCourt::after{
      content:"";
      position:absolute;
      left:12px; right:12px;
      top: 42%;
      height: 3px;
      border-radius: 999px;
      background: var(--court-lines);
      opacity:.55;
      pointer-events:none;
    }
    .lcGrid{
      position:relative;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 10px;
      padding-top: 16px; /* room for net */
      min-height: 260px;
    }
    .lcZone{
      position:relative;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      display:flex;
      align-items:stretch;
      justify-content:stretch;
      padding: 10px;
    }
    [data-theme="light"] .lcZone{
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.55);
    }
    .lcZoneLabel{
      position:absolute;
      top:8px; left:8px;
      font-size:11px;
      font-weight:950;
      color: rgba(255,255,255,.86);
      display:flex;
      align-items:center;
      gap:6px;
      pointer-events:none;
      text-shadow: 0 8px 14px rgba(0,0,0,.20);
    }
    [data-theme="light"] .lcZoneLabel{
      color: rgba(0,0,0,.74);
      text-shadow:none;
    }
    .lcZoneLabel span{
      font-size:10px;
      padding:3px 6px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.22);
      font-weight:950;
      color: rgba(255,255,255,.88);
    }
    [data-theme="light"] .lcZoneLabel span{
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.65);
      color: rgba(0,0,0,.75);
    }

    .lcToken{
      margin-top:auto;
      width:100%;
      border-radius: 14px;
      border: 2px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.92);
      color:#0b1220;
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
      padding: 10px 10px 9px 10px;
      display:flex;
      flex-direction:column;
      gap:4px;
      min-height: 62px;
      justify-content:center;
    }
    .lineupCourt.myA .lcToken{ border-color: rgba(234, 88, 12, .85); }
    .lineupCourt.myB .lcToken{ border-color: rgba(220, 38, 38, .85); }

    .lcToken.empty{
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.80);
      border-style: dashed;
      box-shadow: none;
    }
    [data-theme="light"] .lcToken.empty{
      background: rgba(0,0,0,.05);
      color: rgba(0,0,0,.60);
    }

    .lcName{
      font-weight:950;
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      line-height:1.15;
    }
    .lcRole{
      font-weight:950;
      font-size:10px;
      color: rgba(0,0,0,.60);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .lcToken.empty .lcRole{ color: rgba(255,255,255,.62); }
    [data-theme="light"] .lcRole{ color: rgba(0,0,0,.55); }

    .lcServing{
      outline: 3px solid rgba(112,214,255,.55);
      box-shadow: 0 16px 28px rgba(112,214,255,.18), 0 10px 18px rgba(0,0,0,.25);
    }



    /* =========================
       UI polish (V9)
       - Larger typography
       - Wider layout
       - Mobile bottom tabs
    ========================== */

    body{ font-size: 16px; }

    /* Slightly roomier layout on large screens */
    main{ padding: 20px; }
    .header-inner{ padding: 16px 20px; }

    /* Typography scale-up */
    .brand h1{ font-size: 18px; }
    .brand small{ font-size: 13px; font-weight: 700; }
    .card-header h2{ font-size: 15px; }
    .card-header p{ font-size: 13px; }
    label{ font-size: 13px; }
    .pill{ font-size: 13px; }
    .hint, .mono, .events{ font-size: 13px; }
    textarea{ font-size: 13px; }
    input, select, textarea{ font-size: 14px; }
    .btn{ font-size: 14px; padding: 11px 14px; }
    .btn .icon{ width: 18px; height: 18px; }

    /* Make cards feel a touch more modern */
    .card{ border-radius: 18px; }
    .card-header{ padding: 16px 16px 14px 16px; }
    .card-body{ padding: 16px; }

    /* View tabs: slightly more compact, no wrap on desktop */
    .tabs{ gap: 4px; }
    .tabs button{ min-width: 0; }

    /* Mobile: move view tabs to bottom bar */
    @media (max-width: 760px){
      header{ position: sticky; top: 0; }
      .header-inner{
        padding: 12px 12px;
        gap: 10px;
      }
      .brand{ min-width: 0; }
      .brand small{ display:none; }
      .header-actions{ margin-left: 0; }

      .tabs{
        position: fixed;
        left: 10px;
        right: 10px;
        bottom: calc(10px + env(safe-area-inset-bottom));
        z-index: 3000;
        width: auto;
        justify-content: space-between;
        padding: 6px;
        border-radius: 20px;
        background: rgba(0,0,0,.72);
        backdrop-filter: blur(18px);
        -webkit-backdrop-filter: blur(18px);
        box-shadow: 0 14px 40px rgba(0,0,0,.55);
      }
      [data-theme="light"] .tabs{
        background: rgba(255,255,255,.88);
      }
      .tabs button{
        flex: 1;
        justify-content: center;
        flex-direction: column;
        gap: 4px;
        padding: 10px 6px;
        font-size: 11px;
        line-height: 1.05;
      }
      .tabs .icon{ width: 20px; height: 20px; }

      /* Keep content visible above bottom tabs */
      main{
        padding: 14px 12px;
        padding-bottom: calc(115px + env(safe-area-inset-bottom));
      }

      /* Tighten some dense grids */
      .grid-home, .grid-lineup, .grid-match{ gap: 12px; }
      .steps{ gap: 10px; }

      /* Shorter sim court on mobile */
      .court-container{
        height: clamp(250px, 42vh, 380px);
      }
      .lineupCourt{ max-width: 100%; }
      .lcGrid{ min-height: 220px; }
    }

    /* Print */
    @media print{
      header{display:none !important}
      body{background:white !important; color:black !important}
      main{max-width:none; padding:0}
      .card{box-shadow:none; border: 1px solid rgba(0,0,0,.20)}
      .coachGrid{grid-template-columns: repeat(3, 1fr)}
      .no-print{display:none !important}
    }
  </style>
</head>

<body>
<div class="app" id="appRoot">
  <header>
    <div class="header-inner">
      <div class="brand">
        <svg class="vb" viewBox="0 0 64 64" aria-hidden="true">
          <defs>
            <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="rgba(112,214,255,.95)"/>
              <stop offset="1" stop-color="rgba(139,92,246,.95)"/>
            </linearGradient>
          </defs>
          <circle cx="32" cy="32" r="26" fill="none" stroke="url(#g1)" stroke-width="4"/>
          <path d="M14 26c10 0 20 6 24 16" fill="none" stroke="url(#g1)" stroke-width="3" stroke-linecap="round" opacity=".9"/>
          <path d="M30 8c6 10 6 22 0 32" fill="none" stroke="url(#g1)" stroke-width="3" stroke-linecap="round" opacity=".85"/>
          <path d="M50 20c-9 4-16 12-18 22" fill="none" stroke="url(#g1)" stroke-width="3" stroke-linecap="round" opacity=".85"/>
          <circle cx="32" cy="32" r="2.6" fill="url(#g1)" opacity=".9"/>
        </svg>
        <div>
          <h1>VolleySim Pro+</h1>
          <small>Full-court sim + manual lineups, rotations, coach sheet, JSON save/load</small>
        </div>
      </div>

      <div class="segmented tabs" role="tablist" aria-label="Views">
        <button id="tabHome" role="tab" aria-selected="true" aria-controls="viewHome">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M12 3l9 8h-3v9h-5v-6H11v6H6v-9H3l9-8z"/>
          </svg>
          Home
        </button>
        <button id="tabLineup" role="tab" aria-selected="false" aria-controls="viewLineup">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M4 6h16v2H4V6zm0 5h10v2H4v-2zm0 5h16v2H4v-2zm12-5l4-3v10l-4-3v-4z"/>
          </svg>
          Lineup
        </button>
        <button id="tabSim" role="tab" aria-selected="false" aria-controls="viewSim">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M7 4h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2zm3 4v8l7-4-7-4z"/>
          </svg>
          Simulation
        </button>
        <button id="tabCoach" role="tab" aria-selected="false" aria-controls="viewCoach">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M4 4h16v3H4V4zm0 6h16v10H4V10zm2 2v6h12v-6H6z"/>
          </svg>
          Coach Sheet
        </button>
        <button id="tabRules" role="tab" aria-selected="false" aria-controls="viewRules">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M4 3h14a2 2 0 0 1 2 2v14H6a2 2 0 0 0-2 2V3zm4 5h10v2H8V8zm0 4h10v2H8v-2z"/>
          </svg>
          Rules & Tips
        </button>
      </div>

      <div class="header-actions no-print">
        <button class="btn ghost" id="themeToggle" title="Toggle light/dark mode" aria-label="Toggle light/dark mode">
          <svg class="icon" id="themeIcon" viewBox="0 0 24 24" aria-hidden="true"></svg>
          <span id="themeLabel">Dark</span>
        </button>
      </div>
    </div>
  </header>

  <main>
    
    <!-- HOME VIEW -->
    <section id="viewHome" class="view" role="tabpanel" aria-labelledby="tabHome">
      <section class="card" style="margin-bottom:16px;">
        <div class="card-header">
          <div>
            <h2>üöÄ Quick Start</h2>
            <p>Build your roster ‚Üí set a starting 6 ‚Üí rotate ‚Üí simulate.</p>
          </div>
          <div class="rowBtns no-print">
            <button class="btn primary" id="goLineup">üß© Open Lineup Builder</button>
            <button class="btn" id="goSim">üéÆ Open Simulation</button>
          </div>
        </div>
        <div class="card-body">
          <div class="steps">
            <div class="step">
              <b>1) Add your roster</b>
              <p>Use the Team A/Team B cards below to add players (name, role, ratings). You can keep Team B as a ‚Äúscrimmage opponent‚Äù, or ignore it.</p>
            </div>
            <div class="step">
              <b>2) Assign zones 1‚Äì6</b>
              <p>Each team needs exactly 6 unique players assigned to zones. Zone <b>1</b> is the <b>server</b>. Rotation is clockwise: <span class="mono">1‚Üí6‚Üí5‚Üí4‚Üí3‚Üí2‚Üí1</span>.</p>
            </div>
            <div class="step">
              <b>3) Rotate or simulate</b>
              <p>Use Rotate / Undo / Reset on each team, or run the full rally simulation in the Simulation tab. Coach Sheet prints rotations 1‚Äì6.</p>
            </div>
          </div>
          <div class="hint">Tip: If simulation says your lineups are incomplete, go back to Home or Lineup and fix any warnings.</div>
        </div>
      </section>

      <div class="grid-home">

<section class="card" id="panelA">
          <div class="card-header">
            <div>
              <div class="teamTitle">
                <span class="teamDot a" aria-hidden="true"></span>
                <h2>Team A (Home)</h2>
              </div>
              <p>Add players, assign a 6-person lineup, rotate manually.</p>
            </div>
            <div class="teamMeta">
              <span class="pill">Rot: <strong id="rotA" style="color:var(--text)">1</strong></span>
              <span class="pill">Server: <strong id="serverA" style="color:var(--text)">‚Äî</strong></span>
            </div>
          </div>
          <div class="card-body">
            <div class="fieldRow2">
              <div>
                <label for="name-a">Name</label>
                <input type="text" id="name-a" placeholder="Player name" autocomplete="off" />
              </div>
              <div>
                <label for="jersey-a">Jersey #</label>
                <input type="number" id="jersey-a" placeholder="Optional" min="0" max="99" />
              </div>
            </div>

            <div class="fieldRow" style="margin-top:10px;">
              <div>
                <label for="role-a">Role</label>
                <select id="role-a">
                  <option value="S">Setter (S)</option>
                  <option value="OH">Outside (OH)</option>
                  <option value="MB">Middle (MB)</option>
                  <option value="OPP">Opposite (OPP)</option>
                  <option value="L">Libero (L)</option>
                  <option value="DS">Defensive Specialist (DS)</option>
                </select>
              </div>
              <div>
                <label for="spk-a">Spk (1‚Äì10)</label>
                <input type="number" id="spk-a" min="1" max="10" value="5" />
              </div>
              <div>
                <label for="rcv-a">Rcv (1‚Äì10)</label>
                <input type="number" id="rcv-a" min="1" max="10" value="5" />
              </div>
            </div>

            <div class="rowBtns">
              <button class="btn" id="btnAddA">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M11 5h2v14h-2V5zm-6 6h14v2H5v-2z"/></svg>
                Add Player
              </button>
              <button class="btn" id="btnAutoA" title="Pick best 6 by (spk+rcv) and assign to zones">
                ‚ú® Auto-Lineup
              </button>
            </div>

            <ul class="roster" id="roster-a" aria-label="Team A roster"></ul>

            <div class="notice" id="warnA" role="alert" aria-live="polite"></div>

            <div class="card" style="margin-top:12px; box-shadow:none;">
              <div class="card-header">
                <div>
                  <h2>Lineup (Zones 1‚Äì6)</h2>
                  <p>Assign exactly 6 unique players to zones.</p>
                </div>
                <div class="rowBtns">
                  <button class="btn" id="btnClearA">Clear</button>
                </div>
              </div>
              <div class="card-body">
                <div class="lineupGrid" id="lineupA"></div>
                <div class="rowBtns">
                  <button class="btn primary" id="btnRotateA">Rotate</button>
                  <button class="btn" id="btnUndoA">Undo</button>
                  <button class="btn danger" id="btnResetA">Reset</button>
                </div>
                <div class="hint">Rotate is clockwise: 1‚Üí6‚Üí5‚Üí4‚Üí3‚Üí2‚Üí1. Rotation ‚Äú1‚Äù means no rotations applied.</div>
              </div>
            </div>
          </div>
        </section>

        
<section class="card" id="panelB">
          <div class="card-header">
            <div>
              <div class="teamTitle">
                <span class="teamDot b" aria-hidden="true"></span>
                <h2>Team B (Away)</h2>
              </div>
              <p>Add players, assign a 6-person lineup, rotate manually.</p>
            </div>
            <div class="teamMeta">
              <span class="pill">Rot: <strong id="rotB" style="color:var(--text)">1</strong></span>
              <span class="pill">Server: <strong id="serverB" style="color:var(--text)">‚Äî</strong></span>
            </div>
          </div>
          <div class="card-body">
            <div class="fieldRow2">
              <div>
                <label for="name-b">Name</label>
                <input type="text" id="name-b" placeholder="Player name" autocomplete="off" />
              </div>
              <div>
                <label for="jersey-b">Jersey #</label>
                <input type="number" id="jersey-b" placeholder="Optional" min="0" max="99" />
              </div>
            </div>

            <div class="fieldRow" style="margin-top:10px;">
              <div>
                <label for="role-b">Role</label>
                <select id="role-b">
                  <option value="S">Setter (S)</option>
                  <option value="OH">Outside (OH)</option>
                  <option value="MB">Middle (MB)</option>
                  <option value="OPP">Opposite (OPP)</option>
                  <option value="L">Libero (L)</option>
                  <option value="DS">Defensive Specialist (DS)</option>
                </select>
              </div>
              <div>
                <label for="spk-b">Spk (1‚Äì10)</label>
                <input type="number" id="spk-b" min="1" max="10" value="5" />
              </div>
              <div>
                <label for="rcv-b">Rcv (1‚Äì10)</label>
                <input type="number" id="rcv-b" min="1" max="10" value="5" />
              </div>
            </div>

            <div class="rowBtns">
              <button class="btn" id="btnAddB">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M11 5h2v14h-2V5zm-6 6h14v2H5v-2z"/></svg>
                Add Player
              </button>
              <button class="btn" id="btnAutoB" title="Pick best 6 by (spk+rcv) and assign to zones">
                ‚ú® Auto-Lineup
              </button>
            </div>

            <ul class="roster" id="roster-b" aria-label="Team B roster"></ul>

            <div class="notice" id="warnB" role="alert" aria-live="polite"></div>

            <div class="card" style="margin-top:12px; box-shadow:none;">
              <div class="card-header">
                <div>
                  <h2>Lineup (Zones 1‚Äì6)</h2>
                  <p>Assign exactly 6 unique players to zones.</p>
                </div>
                <div class="rowBtns">
                  <button class="btn" id="btnClearB">Clear</button>
                </div>
              </div>
              <div class="card-body">
                <div class="lineupGrid" id="lineupB"></div>
                <div class="rowBtns">
                  <button class="btn primary" id="btnRotateB">Rotate</button>
                  <button class="btn" id="btnUndoB">Undo</button>
                  <button class="btn danger" id="btnResetB">Reset</button>
                </div>
                <div class="hint">Rotate is clockwise: 1‚Üí6‚Üí5‚Üí4‚Üí3‚Üí2‚Üí1. Rotation ‚Äú1‚Äù means no rotations applied.</div>
              </div>
            </div>
          </div>
        </section>
      </div>

<!-- SAVE / LOAD -->
      <section class="card" style="margin-top:16px;">
        <div class="card-header">
          <div>
            <h2>üíæ Save / Load</h2>
            <p>Export/import the full app state (rosters, lineups, rotations, score, settings).</p>
          </div>
          <div class="rowBtns no-print">
            <button class="btn" id="btnCopyJson" title="Copy JSON">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path fill="currentColor" d="M16 1H6a2 2 0 0 0-2 2v12h2V3h10V1zm3 4H10a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h9a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 16H10V7h9v14z"/>
              </svg>
              Copy JSON
            </button>
            <button class="btn" id="btnLoadJson" title="Load JSON from box">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path fill="currentColor" d="M19 15v4H5v-4H3v6h18v-6h-2zM11 3h2v10l3-3 1.4 1.4L12 17l-5.4-5.6L8 10l3 3V3z"/>
              </svg>
              Load JSON
            </button>
          </div>
        </div>
        <div class="card-body saveGrid">
          <div>
            <label for="jsonBox">JSON</label>
            <textarea id="jsonBox" placeholder='Paste JSON here... (Export will also place JSON here)'></textarea>
            <div class="ok" id="jsonOk" role="status" aria-live="polite"></div>
            <div class="notice" id="jsonErr" role="alert" aria-live="polite"></div>
          </div>
          <div>
            <div class="card" style="box-shadow:none;">
              <div class="card-header">
                <div>
                  <h2>Notes</h2>
                  <p>How rotations & serving work</p>
                </div>
              </div>
              <div class="card-body">
                <ul class="events" style="margin:0;">
                  <li><b>Rotation mapping</b> is clockwise: <span class="mono">1‚Üí6‚Üí5‚Üí4‚Üí3‚Üí2‚Üí1</span>.</li>
                  <li><b>Server</b> is whoever is currently in <b>zone 1</b> for the serving team.</li>
                  <li><b>Simulation</b> uses rally scoring; if the receiving team wins a rally, it rotates (side-out) and gains the serve.</li>
                </ul>
                <div class="hint">Pro tip: After importing JSON, open Coach Sheet to print rotations 1‚Äì6.</div>
              </div>
            </div>
          </div>
        </div>
      </section>
    
    </section>


    <!-- LINEUP VIEW -->
    <section id="viewLineup" class="view hidden" role="tabpanel" aria-labelledby="tabLineup">
      <div class="grid-lineup">
        <section class="card">
          <div class="card-header">
            <div>
              <h2>üß© Lineup Builder</h2>
              <p>Create and optimize a starting 6 for your team.</p>
            </div>
            <div class="teamMeta no-print">
              <div class="segmented" role="tablist" aria-label="Lineup team selector">
                <button id="myTeamA" aria-selected="true" type="button">My Team: A</button>
                <button id="myTeamB" aria-selected="false" type="button">My Team: B</button>
              </div>
            </div>
          </div>

          <div class="card-body">
            <div class="fieldRow2">
              <div>
                <label for="my-name">Name</label>
                <input type="text" id="my-name" placeholder="Player name" autocomplete="off" />
              </div>
              <div>
                <label for="my-jersey">Jersey #</label>
                <input type="number" id="my-jersey" placeholder="Optional" min="0" max="99" />
              </div>
            </div>

            <div class="fieldRow" style="margin-top:10px;">
              <div>
                <label for="my-role">Role</label>
                <select id="my-role">
                  <option value="S">Setter (S)</option>
                  <option value="OH" selected>Outside (OH)</option>
                  <option value="MB">Middle (MB)</option>
                  <option value="OPP">Opposite (OPP)</option>
                  <option value="L">Libero (L)</option>
                  <option value="DS">Defensive Specialist (DS)</option>
                </select>
              </div>
              <div>
                <label for="my-spk">Spk (1‚Äì10)</label>
                <input type="number" id="my-spk" min="1" max="10" value="5" />
              </div>
              <div>
                <label for="my-rcv">Rcv (1‚Äì10)</label>
                <input type="number" id="my-rcv" min="1" max="10" value="5" />
              </div>
            </div>

            <div class="rowBtns">
              <button class="btn" id="btnMyAdd">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M11 5h2v14h-2V5zm-6 6h14v2H5v-2z"/></svg>
                Add Player
              </button>
              <button class="btn" id="btnMyAuto" title="Pick best 6 by (spk+rcv) and assign to zones">
                ‚ú® Auto-Lineup
              </button>
              <button class="btn primary" id="btnMyOptimize" title="Smarter role-based assignment (5‚Äì1 style)">
                üß† Optimize
              </button>
            </div>

            <ul class="roster" id="roster-my" aria-label="My team roster"></ul>
            <div class="notice" id="warnMy" role="alert" aria-live="polite"></div>

            <div class="card" style="margin-top:12px; box-shadow:none;">
              <div class="card-header">
                <div>
                  <h2>My Starting 6 (Zones 1‚Äì6)</h2>
                  <p>Tip: For many teams, a simple 5‚Äì1 start is <b>Setter in zone 1</b>, <b>Opposite in zone 2</b>.</p>
                </div>
                <div class="rowBtns">
                  <button class="btn" id="btnMyClear">Clear</button>
                </div>
              </div>
              <div class="card-body">
                <div class="lineupGrid" id="lineupMy"></div>
                <div class="rowBtns">
                  <button class="btn primary" id="btnMyRotate">Rotate</button>
                  <button class="btn" id="btnMyUndo">Undo</button>
                  <button class="btn danger" id="btnMyReset">Reset</button>
                </div>
                <div class="hint">Rotation is clockwise: <span class="mono">1‚Üí6‚Üí5‚Üí4‚Üí3‚Üí2‚Üí1</span>. Zone <b>1</b> is always the server.</div>
              </div>
            </div>

            <div class="rowBtns" style="margin-top:12px;">
              <button class="btn" id="lineupGoHome">üè† Back to Home</button>
              <button class="btn" id="lineupGoSim">üéÆ Run Simulation</button>
            </div>
          </div>
        </section>

        
        <section class="card">
          <div class="card-header">
            <div>
              <h2>üèê Court Preview + Insights</h2>
              <p>See where your 6 are on the court (including rotation) + quick stats.</p>
            </div>
            <div class="teamMeta">
              <span class="pill">My team: <strong id="myTeamLabel" style="color:var(--text)">A</strong></span>
              <span class="pill">Rot: <strong id="myRotLabel" style="color:var(--text)">1</strong></span>
            </div>
          </div>

          <div class="card-body">
            <div class="lineupCourt myA" id="myCourtPreview" aria-label="Lineup court preview">
              <div class="lcGrid" role="group" aria-label="Zones 4 3 2 / 5 6 1">
                <div class="lcZone" data-zone="4">
                  <div class="lcZoneLabel">4 <span>LF</span></div>
                  <div class="lcToken empty" id="lc-token-4">
                    <div class="lcName" id="lc-name-4">‚Äî Empty</div>
                    <div class="lcRole" id="lc-role-4">Pick a player</div>
                  </div>
                </div>
                <div class="lcZone" data-zone="3">
                  <div class="lcZoneLabel">3 <span>MF</span></div>
                  <div class="lcToken empty" id="lc-token-3">
                    <div class="lcName" id="lc-name-3">‚Äî Empty</div>
                    <div class="lcRole" id="lc-role-3">Pick a player</div>
                  </div>
                </div>
                <div class="lcZone" data-zone="2">
                  <div class="lcZoneLabel">2 <span>RF</span></div>
                  <div class="lcToken empty" id="lc-token-2">
                    <div class="lcName" id="lc-name-2">‚Äî Empty</div>
                    <div class="lcRole" id="lc-role-2">Pick a player</div>
                  </div>
                </div>

                <div class="lcZone" data-zone="5">
                  <div class="lcZoneLabel">5 <span>LB</span></div>
                  <div class="lcToken empty" id="lc-token-5">
                    <div class="lcName" id="lc-name-5">‚Äî Empty</div>
                    <div class="lcRole" id="lc-role-5">Pick a player</div>
                  </div>
                </div>
                <div class="lcZone" data-zone="6">
                  <div class="lcZoneLabel">6 <span>MB</span></div>
                  <div class="lcToken empty" id="lc-token-6">
                    <div class="lcName" id="lc-name-6">‚Äî Empty</div>
                    <div class="lcRole" id="lc-role-6">Pick a player</div>
                  </div>
                </div>
                <div class="lcZone" data-zone="1">
                  <div class="lcZoneLabel">1 <span>RB</span></div>
                  <div class="lcToken empty lcServing" id="lc-token-1">
                    <div class="lcName" id="lc-name-1">‚Äî Empty</div>
                    <div class="lcRole" id="lc-role-1">Server zone</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="hint" style="margin-top:10px;">
              Front row is zones <b>4‚Äì3‚Äì2</b> (near the net). Back row is <b>5‚Äì6‚Äì1</b>. Zone <b>1</b> is the server.
            </div>

            <div style="height:12px;"></div>
            <div id="myInsights"><div class="hint">Assign 6 players to zones to see insights.</div></div>
          </div>
        </section>

      </div>
    </section>


    <!-- SIMULATION VIEW -->
    <section id="viewSim" class="view hidden" role="tabpanel" aria-labelledby="tabSim">
      <section class="card" style="margin-bottom:16px;">
        <div class="card-header">
          <div>
            <h2>üéÆ Simulation</h2>
            <p>Rally scoring + side-out rotations. Uses your current Team A / Team B lineups.</p>
          </div>
          <div class="rowBtns no-print">
            <button class="btn" id="simGoHome">üè† Back to Home</button>
          </div>
        </div>
        <div class="card-body">
          <ul class="events" style="margin:0;">
            <li>Receiver wins rally ‚Üí <b>side-out</b>: they rotate and gain the serve.</li>
            <li>Game ends at target points with a <b>2-point lead</b>.</li>
          </ul>
        </div>
      </section>

      <section class="card" id="panelCourt">
          <div class="card-header">
            <div>
              <h2>üèüÔ∏è Court + Match Simulation</h2>
              <p>Simulation uses rally scoring + realistic rotations on side-out (receiver wins the rally).</p>
            </div>
            <div class="teamMeta">
              <label class="toggle" title="Show/hide zone labels on the court">
                <input type="checkbox" id="toggleZones" checked />
                <span>Zone labels</span>
              </label>
              <label class="toggle" title="Show/hide role chips on tokens">
                <input type="checkbox" id="toggleRoles" checked />
                <span>Role chips</span>
              </label>
            </div>
          </div>
          <div class="card-body">
            <div class="notice" id="simWarn" role="alert" aria-live="polite"></div>
            <div class="scoreboard" role="group" aria-label="Scoreboard">
              <div class="scoreSide">
                <div class="teamLabel"><span class="teamDot a"></span> Team A</div>
                <div class="scoreNum a" id="score-a-display">0</div>
              </div>

              <div class="centerStatus">
                <div class="vs">VS</div>
                <div class="status" id="sim-status">Waiting to start</div>
                <div class="servePill" id="serve-pill">üèê Serve: <span id="serve-team">A</span> ‚Äî <span id="serve-player">‚Äî</span></div>
              </div>

              <div class="scoreSide right">
                <div class="teamLabel">Team B <span class="teamDot b"></span></div>
                <div class="scoreNum b" id="score-b-display">0</div>
              </div>
            </div>

            <div class="courtWrap">
              <div class="controlsRow no-print">
                <div class="controlsLeft">
                  <button class="btn primary" id="btn-sim">üéÆ Play Simulation</button>
                  <button class="btn" id="btn-stop">Stop</button>
                  <button class="btn danger" id="btn-reset-match">Reset Match</button>
                </div>
                <div class="controlsRight">
                  <div style="min-width:150px;">
                    <label for="targetPoints" style="margin:0 0 6px 0;">Play to</label>
                    <input id="targetPoints" type="number" min="1" max="99" value="15" />
                  </div>
                  <div style="min-width:170px;">
                    <label for="speed" style="margin:0 0 6px 0;">Speed</label>
                    <select id="speed">
                      <option value="0.75">Fast</option>
                      <option value="1" selected>Normal</option>
                      <option value="1.35">Slow</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="court-container" id="court" aria-label="Full volleyball court">
                <div class="center-line" aria-hidden="true"></div>
                <div class="net" aria-hidden="true"></div>
                <div class="attack-line-top" aria-hidden="true"></div>
                <div class="attack-line-bot" aria-hidden="true"></div>

                <!-- Zone labels (12) injected via JS -->
                <div id="zoneLabels"></div>

                <!-- Ball -->
                <div class="game-ball" id="ball">üèê</div>

                <!-- Tokens: slots 1..6 per team -->
                <div class="player-token team-a-token" id="a-token-1"><div class="token-jersey" id="a-jersey-1"></div><div class="token-name" id="a-name-1"></div><div class="token-role" id="a-role-1"></div></div>
                <div class="player-token team-a-token" id="a-token-2"><div class="token-jersey" id="a-jersey-2"></div><div class="token-name" id="a-name-2"></div><div class="token-role" id="a-role-2"></div></div>
                <div class="player-token team-a-token" id="a-token-3"><div class="token-jersey" id="a-jersey-3"></div><div class="token-name" id="a-name-3"></div><div class="token-role" id="a-role-3"></div></div>
                <div class="player-token team-a-token" id="a-token-4"><div class="token-jersey" id="a-jersey-4"></div><div class="token-name" id="a-name-4"></div><div class="token-role" id="a-role-4"></div></div>
                <div class="player-token team-a-token" id="a-token-5"><div class="token-jersey" id="a-jersey-5"></div><div class="token-name" id="a-name-5"></div><div class="token-role" id="a-role-5"></div></div>
                <div class="player-token team-a-token" id="a-token-6"><div class="token-jersey" id="a-jersey-6"></div><div class="token-name" id="a-name-6"></div><div class="token-role" id="a-role-6"></div></div>

                <div class="player-token team-b-token" id="b-token-1"><div class="token-jersey" id="b-jersey-1"></div><div class="token-name" id="b-name-1"></div><div class="token-role" id="b-role-1"></div></div>
                <div class="player-token team-b-token" id="b-token-2"><div class="token-jersey" id="b-jersey-2"></div><div class="token-name" id="b-name-2"></div><div class="token-role" id="b-role-2"></div></div>
                <div class="player-token team-b-token" id="b-token-3"><div class="token-jersey" id="b-jersey-3"></div><div class="token-name" id="b-name-3"></div><div class="token-role" id="b-role-3"></div></div>
                <div class="player-token team-b-token" id="b-token-4"><div class="token-jersey" id="b-jersey-4"></div><div class="token-name" id="b-name-4"></div><div class="token-role" id="b-role-4"></div></div>
                <div class="player-token team-b-token" id="b-token-5"><div class="token-jersey" id="b-jersey-5"></div><div class="token-name" id="b-name-5"></div><div class="token-role" id="b-role-5"></div></div>
                <div class="player-token team-b-token" id="b-token-6"><div class="token-jersey" id="b-jersey-6"></div><div class="token-name" id="b-name-6"></div><div class="token-role" id="b-role-6"></div></div>
              </div>

              <div class="eventLog">
                <h3>Last rallies</h3>
                <ul class="events" id="events"></ul>
                <div class="hint mono">Tip: Use Auto-Lineup on both teams, then press Play. Manual rotate buttons also work anytime.</div>
              </div>
            </div>
          </div>
        </section>

        
    </section>

<!-- COACH SHEET VIEW -->
    <section id="viewCoach" class="view hidden" role="tabpanel" aria-labelledby="tabCoach">
      <section class="card">
        <div class="card-header">
          <div>
            <h2>üìù Coach Sheet (Rotations 1‚Äì6)</h2>
            <p>Printable reference from the current lineup + current rotation.</p>
          </div>
          <div class="coachTop no-print">
            <div class="segmented" role="tablist" aria-label="Coach team selector">
              <button id="coachTeamA" aria-selected="true" type="button">Team A</button>
              <button id="coachTeamB" aria-selected="false" type="button">Team B</button>
            </div>
            <div class="rowBtns">
              <button class="btn" id="btnPrint">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                  <path fill="currentColor" d="M6 7V3h12v4H6zm12 2h1a3 3 0 0 1 3 3v5h-4v4H6v-4H2v-5a3 3 0 0 1 3-3h1v2h12V9zM8 19v2h8v-2H8z"/>
                </svg>
                Print
              </button>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="notice" id="coachWarn" role="alert" aria-live="polite"></div>
          <div class="coachGrid" id="coachGrid"></div>
        </div>
      </section>
    </section>
  
    <!-- RULES VIEW -->
    <section id="viewRules" class="view hidden" role="tabpanel" aria-labelledby="tabRules">
      <section class="card">
        <div class="card-header">
          <div>
            <h2>Volleyball Rules & Tips</h2>
            <p>Fast refresher (simplified) + practical coaching reminders.</p>
          </div>
          <div class="rowBtns no-print">
            <button class="btn" id="rulesGoHome">üè† Back to Home</button>
          </div>
        </div>
        <div class="card-body">
          <details open>
            <summary>Scoring & sets <span class="summaryHint">rally scoring</span></summary>
            <div class="ruleBody">
              <ul class="events" style="margin:0;">
                <li>Every rally is a point (rally scoring).</li>
                <li>Most indoor matches play best-of-5 sets (first to 25; 5th set often to 15), win by 2.</li>
                <li>After each rally, the team that won the rally serves next.</li>
              </ul>
            </div>
          </details>

          <details>
            <summary>Rotation basics <span class="summaryHint">clockwise</span></summary>
            <div class="ruleBody">
              <p>Teams rotate <b>only</b> when they win a rally as the <b>receiving</b> team (a side-out). Rotation is clockwise:</p>
              <p class="mono">1‚Üí6‚Üí5‚Üí4‚Üí3‚Üí2‚Üí1</p>
              <ul class="events" style="margin:0;">
                <li>Zone 1 = Right Back (server).</li>
                <li>Front row zones: 2, 3, 4. Back row zones: 1, 6, 5.</li>
                <li>After serve, players can move to their base/defensive positions (as long as they were legal at contact).</li>
              </ul>
            </div>
          </details>

          <details>
            <summary>Positions (simple) <span class="summaryHint">roles</span></summary>
            <div class="ruleBody">
              <ul class="events" style="margin:0;">
                <li><b>Setter (S)</b>: runs the offense, often wants touches 2nd ball.</li>
                <li><b>Outside (OH)</b>: primary passer + attacker on left side.</li>
                <li><b>Middle (MB)</b>: quick attacker + main blocker, usually in the middle front zones.</li>
                <li><b>Opposite (OPP)</b>: right-side attacker, commonly blocks the opponent‚Äôs OH.</li>
                <li><b>Libero (L) / DS</b>: back-row defense + passing; usually not a primary attacker.</li>
              </ul>
            </div>
          </details>

          <details>
            <summary>Libero notes <span class="summaryHint">common rules</span></summary>
            <div class="ruleBody">
              <ul class="events" style="margin:0;">
                <li>Libero is a defensive specialist and wears a different jersey in most rulesets.</li>
                <li>Often replaces middles in the back row to improve passing/defense.</li>
                <li>Libero generally cannot complete an attack hit above the net from the front zone.</li>
              </ul>
              <p class="hint">Rules vary by league ‚Äî treat this as a quick reminder, not an official rulebook.</p>
            </div>
          </details>

          <details>
            <summary>Serving & common faults <span class="summaryHint">quick list</span></summary>
            <div class="ruleBody">
              <ul class="events" style="margin:0;">
                <li>Server must contact the ball behind the end line; foot faults are called in many leagues.</li>
                <li>Double contact on the 1st ball is usually more lenient than on the 2nd contact (depends on league).</li>
                <li>Net touches, center-line faults, illegal back-row attacks, and rotational faults are common calls.</li>
              </ul>
            </div>
          </details>

          <details>
            <summary>Practical tips <span class="summaryHint">coach</span></summary>
            <div class="ruleBody">
              <ul class="events" style="margin:0;">
                <li><b>Serve order</b>: your serve order is simply zones 1‚Üí2‚Üí3‚Üí4‚Üí5‚Üí6.</li>
                <li><b>Keep two passers</b> in serve receive whenever possible.</li>
                <li><b>Know your mismatch</b>: if your OPP is strong, try to keep them against their OH in the front row.</li>
                <li><b>Simple first</b>: run a clean free-ball plan (pass ‚Üí set ‚Üí controlled swing) before adding complex plays.</li>
              </ul>
            </div>
          </details>

        </div>
      </section>
    </section>


  </main>
</div>

<script>
/* =====================================================
   Core constants
===================================================== */
const ROT_FLOW = { 1: 6, 6: 5, 5: 4, 4: 3, 3: 2, 2: 1 }; // clockwise
const ZONES = {
  1: { short: "RB",  name: "Right Back (Server)" },
  2: { short: "RF",  name: "Right Front" },
  3: { short: "MF",  name: "Middle Front" },
  4: { short: "LF",  name: "Left Front" },
  5: { short: "LB",  name: "Left Back" },
  6: { short: "MB",  name: "Middle Back" },
};

const DEFAULTS = {
  A: [
    { name:"Hinata", jersey:"10", role:"OH", spk:9, rcv:5 },
    { name:"Kageyama", jersey:"9", role:"S", spk:8, rcv:8 },
    { name:"Daichi", jersey:"1", role:"OH", spk:6, rcv:10 },
    { name:"Asahi", jersey:"4", role:"OPP", spk:10, rcv:6 },
    { name:"Tsukishima", jersey:"11", role:"MB", spk:8, rcv:7 },
    { name:"Nishinoya", jersey:"5", role:"L", spk:2, rcv:10 },
  ],
  B: [
    { name:"Kuroo", jersey:"1", role:"MB", spk:8, rcv:9 },
    { name:"Kenma", jersey:"3", role:"S", spk:4, rcv:8 },
    { name:"Yamamoto", jersey:"2", role:"OH", spk:9, rcv:7 },
    { name:"Yaku", jersey:"4", role:"L", spk:2, rcv:10 },
    { name:"Lev", jersey:"12", role:"OPP", spk:10, rcv:3 },
    { name:"Fukunaga", jersey:"7", role:"OH", spk:7, rcv:8 },
  ]
};

/* =====================================================
   Theme (V5-style)
===================================================== */
const THEME_KEY = "vb_theme_v5like";
function getPreferredTheme(){
  const saved = localStorage.getItem(THEME_KEY);
  if (saved === "light" || saved === "dark") return saved;
  return (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? "dark" : "light";
}
function setTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem(THEME_KEY, theme);
  updateThemeButton(theme);
}
function updateThemeButton(theme){
  const label = document.getElementById("themeLabel");
  const icon = document.getElementById("themeIcon");
  label.textContent = theme === "dark" ? "Dark" : "Light";
  icon.setAttribute("viewBox","0 0 24 24");
  if (theme === "dark"){
    icon.innerHTML = `<path fill="currentColor" d="M12 3a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0V4a1 1 0 0 1 1-1zm7.07 2.93a1 1 0 0 1 0 1.41l-1.41 1.41a1 1 0 0 1-1.41-1.41l1.41-1.41a1 1 0 0 1 1.41 0zM21 11a1 1 0 0 1 1 1v0a1 1 0 0 1-1 1h-2a1 1 0 1 1 0-2h2zM6.34 6.34a1 1 0 0 1-1.41 0L3.52 4.93a1 1 0 0 1 1.41-1.41l1.41 1.41a1 1 0 0 1 0 1.41zM5 12a1 1 0 0 1-1 1H2a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1zm13.07 5.66a1 1 0 0 1-1.41 1.41l-1.41-1.41a1 1 0 1 1 1.41-1.41l1.41 1.41zM12 18a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0v-2a1 1 0 0 1 1-1zM7.75 16.25a1 1 0 0 1 0 1.41l-1.41 1.41a1 1 0 0 1-1.41-1.41l1.41-1.41a1 1 0 0 1 1.41 0zM12 7a5 5 0 1 0 0 10 5 5 0 0 0 0-10z"/>`;
  } else {
    icon.innerHTML = `<path fill="currentColor" d="M21 14.5A7.5 7.5 0 0 1 9.5 3.3a.9.9 0 0 1 1.1 1.1A5.7 5.7 0 1 0 19.6 13.4a.9.9 0 0 1 1.1 1.1c-.3.9-.4.9-.7 0z"/>`;
  }
}

/* =====================================================
   State
===================================================== */
function uid(){
  return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
}

let state = {
  version: 1,
  ui: {
    showZones: true,
    showRoles: true,
  },
  settings: {
    targetPoints: 15,
    speed: 1,
  },
  game: {
    scoreA: 0,
    scoreB: 0,
    serverTeam: "A",
    simActive: false,
    status: "Waiting to start",
    events: [],
  },
  teams: {
    A: { roster: [], lineup: {1:null,2:null,3:null,4:null,5:null,6:null}, rot: 0, history: [] },
    B: { roster: [], lineup: {1:null,2:null,3:null,4:null,5:null,6:null}, rot: 0, history: [] },
  },
  coach: {
    team: "A",
  }
};

function makePlayer({name, jersey="", role="OH", spk=5, rcv=5}){
  const p = {
    id: uid(),
    name: String(name || "").trim(),
    jersey: String(jersey || "").trim(),
    role: String(role || "OH"),
    spk: clampInt(spk, 1, 10, 5),
    rcv: clampInt(rcv, 1, 10, 5),
  };
  p.total = p.spk + p.rcv;
  return p;
}

/* =====================================================
   Court coordinate mappings (Gemini-style full court)
   Team A is bottom half, Team B is top half (mirrored)
===================================================== */
const COORDS_A = {
  1: { left: '83%', top: '88%' }, // RB
  2: { left: '83%', top: '62%' }, // RF
  3: { left: '50%', top: '62%' }, // MF
  4: { left: '16%', top: '62%' }, // LF
  5: { left: '16%', top: '88%' }, // LB
  6: { left: '50%', top: '88%' }  // MB
};
const COORDS_B = {
  1: { left: '16%', top: '12%' }, // RB (viewer-left)
  2: { left: '16%', top: '38%' }, // RF
  3: { left: '50%', top: '38%' }, // MF
  4: { left: '83%', top: '38%' }, // LF
  5: { left: '83%', top: '12%' }, // LB
  6: { left: '50%', top: '12%' }  // MB
};

function coordsFor(team, zone){
  return (team === "A" ? COORDS_A[zone] : COORDS_B[zone]);
}

/* =====================================================
   Helpers
===================================================== */
function clampInt(v, min, max, fallback){
  const n = Number(v);
  if (!Number.isFinite(n)) return fallback;
  return Math.max(min, Math.min(max, Math.round(n)));
}
function otherTeam(team){ return team === "A" ? "B" : "A"; }

function applyRotation(slotZone, rotCount){
  let z = slotZone;
  for (let i=0; i<rotCount; i++) z = ROT_FLOW[z];
  return z;
}

function getPlayer(team, playerId){
  if (!playerId) return null;
  return state.teams[team].roster.find(p => p.id === playerId) || null;
}

function lineupPlayers(team){
  const t = state.teams[team];
  const arr = [];
  for (let i=1; i<=6; i++){
    const p = getPlayer(team, t.lineup[i]);
    if (p) arr.push(p);
  }
  return arr;
}

function validateLineup(team){
  const t = state.teams[team];
  const ids = [];
  const issues = [];
  for (let z=1; z<=6; z++){
    const pid = t.lineup[z];
    if (!pid) issues.push(`Zone ${z} is unassigned.`);
    else ids.push(pid);
  }
  const unique = new Set(ids);
  if (unique.size !== ids.length) issues.push("Duplicate players in lineup (same player assigned to multiple zones).");
  if (ids.length !== 6) issues.push("Lineup must have exactly 6 players.");
  // ensure all are in roster
  ids.forEach(pid => {
    if (!getPlayer(team, pid)) issues.push("A selected lineup player no longer exists in the roster.");
  });
  return issues;
}

function formatPlayerShort(p){
  if (!p) return "‚Äî";
  const jersey = (p.jersey || "").trim();
  const nm = (p.name || "").trim() || "Unnamed";
  return jersey ? `#${jersey} ${nm}` : nm;
}

function pushEvent(msg){
  state.game.events.unshift(msg);
  state.game.events = state.game.events.slice(0, 6);
  renderEvents();
}

function setStatus(txt){
  state.game.status = txt;
  document.getElementById("sim-status").textContent = txt;
}

function showWarn(elId, msg){
  const el = document.getElementById(elId);
  if (!msg){
    el.classList.remove("show");
    el.textContent = "";
    return;
  }
  el.textContent = msg;
  el.classList.add("show");
}

function showOk(msg){
  const ok = document.getElementById("jsonOk");
  const err = document.getElementById("jsonErr");
  ok.textContent = msg;
  ok.classList.add("show");
  err.classList.remove("show");
  err.textContent = "";
  setTimeout(()=>ok.classList.remove("show"), 2400);
}
function showErr(msg){
  const ok = document.getElementById("jsonOk");
  const err = document.getElementById("jsonErr");
  err.textContent = msg;
  err.classList.add("show");
  ok.classList.remove("show");
  ok.textContent = "";
}

async function copyToClipboard(text){
  const box = document.getElementById("jsonBox");
  box.value = text;
  try{
    await navigator.clipboard.writeText(text);
    showOk("Copied JSON to clipboard.");
  }catch(e){
    box.focus(); box.select();
    document.execCommand("copy");
    showOk("Copied JSON (fallback).");
  }
}

const wait = (ms) => new Promise(res => setTimeout(res, ms));

/* =====================================================
   Rendering: rosters, lineups, court, coach
===================================================== */
function renderRosters(){
  ["A","B"].forEach(team=>{
    const list = document.getElementById(team==="A" ? "roster-a" : "roster-b");
    const roster = state.teams[team].roster;
    list.innerHTML = roster.map(p => `
      <li>
        <div class="rMain">
          <div class="rName">${escapeHtml(formatPlayerShort(p))} <span class="tag">${escapeHtml(p.role)}</span></div>
          <div class="rSub">S:${p.spk} R:${p.rcv} ‚Ä¢ Total:${p.total}</div>
        </div>
        <div class="miniBtns">
          <button class="miniBtn" title="Remove" aria-label="Remove ${escapeAttr(p.name)}" data-rm="${p.id}" data-team="${team}">‚úñ</button>
        </div>
      </li>
    `).join("");

    // bind remove
    list.querySelectorAll("button[data-rm]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        removePlayer(btn.getAttribute("data-team"), btn.getAttribute("data-rm"));
      });
    });
  });

  // After roster changes, ensure lineup selects stay in sync
  renderLineups();
}

function renderLineups(){
  ["A","B"].forEach(team=>{
    const container = document.getElementById(team==="A" ? "lineupA" : "lineupB");
    const roster = state.teams[team].roster;
    const lineup = state.teams[team].lineup;

    container.innerHTML = "";
    for (let z=1; z<=6; z++){
      const opts = roster.map(p => `<option value="${escapeAttr(p.id)}">${escapeHtml(formatPlayerShort(p))} ‚Ä¢ ${escapeHtml(p.role)} ‚Ä¢ (S${p.spk}/R${p.rcv})</option>`).join("");
      const selVal = lineup[z] || "";
      const zoneName = `${z} ‚Äî ${ZONES[z].short}`;
      const zoneDesc = ZONES[z].name;

      const div = document.createElement("div");
      div.className = "slot";
      div.innerHTML = `
        <div>
          <b>${zoneName}</b>
          <small>${escapeHtml(zoneDesc)}</small>
        </div>
        <div>
          <select data-team="${team}" data-zone="${z}" aria-label="Select player for zone ${z}">
            <option value="">‚Äî Select player ‚Äî</option>
            ${opts}
          </select>
        </div>
      `;
      container.appendChild(div);

      const sel = div.querySelector("select");
      sel.value = selVal;

      sel.addEventListener("change", ()=>{
        state.teams[team].lineup[z] = sel.value || null;
        // If roster changed and selection becomes invalid, keep null
        if (state.teams[team].lineup[z] && !getPlayer(team, state.teams[team].lineup[z])) state.teams[team].lineup[z] = null;
        updateTeamWarnings(team);
        updateCourt();
        renderCoach(); // keep coach sheet live
      });
    }

    updateTeamWarnings(team);
  });

  updateCourt();
  updateSimWarnings();
  renderMyLineup();
}

function updateTeamWarnings(team){
  const issues = validateLineup(team);
  showWarn(team==="A" ? "warnA" : "warnB", issues.length ? issues.join("\n") : "");
  updateSimWarnings();
  updateMyWarnings();
  renderMyCourtPreview();
}

/* =====================================================
   Simulation warnings (so you can see issues on the Simulation tab)
===================================================== */
function updateSimWarnings(){
  const a = validateLineup("A");
  const b = validateLineup("B");
  const msgs = [];
  if (a.length) msgs.push("Team A: " + a.join(" "));
  if (b.length) msgs.push("Team B: " + b.join(" "));
  const msg = msgs.length ? ("Fix lineups before sim:\n" + msgs.join("\n")) : "";
  const el = document.getElementById("simWarn");
  if (el) showWarn("simWarn", msg);
}

/* =====================================================
   Lineup Builder tab (My Team)
===================================================== */
function getMyTeam(){ return state.ui.myTeam || "A"; }

function setMyTeam(team){
  state.ui.myTeam = (team === "B") ? "B" : "A";
  const aBtn = document.getElementById("myTeamA");
  const bBtn = document.getElementById("myTeamB");
  if (aBtn && bBtn){
    aBtn.setAttribute("aria-selected", state.ui.myTeam === "A" ? "true" : "false");
    bBtn.setAttribute("aria-selected", state.ui.myTeam === "B" ? "true" : "false");
  }
  const lbl = document.getElementById("myTeamLabel");
  if (lbl) lbl.textContent = state.ui.myTeam;
  renderMyLineup();
  renderMyInsights();
  renderMyCourtPreview();
}

function addMyPlayer(){
  const team = getMyTeam();
  const name = (document.getElementById("my-name").value || "").trim();
  const jersey = (document.getElementById("my-jersey").value || "").trim();
  const role = document.getElementById("my-role").value;
  const spk = clampInt(document.getElementById("my-spk").value, 1, 10, 5);
  const rcv = clampInt(document.getElementById("my-rcv").value, 1, 10, 5);
  if (!name) return;

  state.teams[team].roster.push(makePlayer({name, jersey, role, spk, rcv}));

  document.getElementById("my-name").value = "";
  document.getElementById("my-jersey").value = "";
  document.getElementById("my-spk").value = 5;
  document.getElementById("my-rcv").value = 5;

  renderRosters(); // will also update lineups/court + my view
  renderMyLineup();
  renderMyInsights();
  renderMyCourtPreview();
}

function updateMyWarnings(){
  const warn = document.getElementById("warnMy");
  if (!warn) return; // view might not exist (still safe)
  const team = getMyTeam();
  const issues = validateLineup(team);
  showWarn("warnMy", issues.length ? issues.join("\n") : "");
  const rotLbl = document.getElementById("myRotLabel");
  if (rotLbl) rotLbl.textContent = String(state.teams[team].rot + 1);
}

function renderMyLineup(){
  const rosterUl = document.getElementById("roster-my");
  const lineupDiv = document.getElementById("lineupMy");
  if (!rosterUl || !lineupDiv) return;

  const team = getMyTeam();
  const roster = state.teams[team].roster;
  const lineup = state.teams[team].lineup;

  // roster list
  rosterUl.innerHTML = roster.map(p => `
    <li>
      <div class="rMain">
        <div class="rName">${escapeHtml(formatPlayerShort(p))} <span class="tag">${escapeHtml(p.role)}</span></div>
        <div class="rSub">S:${p.spk} R:${p.rcv} ‚Ä¢ Total:${p.total}</div>
      </div>
      <div class="miniBtns">
        <button class="miniBtn" title="Remove" aria-label="Remove ${escapeAttr(p.name)}" data-rm="${p.id}">‚úñ</button>
      </div>
    </li>
  `).join("");

  rosterUl.querySelectorAll("button[data-rm]").forEach(btn=>{
    btn.addEventListener("click", ()=>removePlayer(team, btn.getAttribute("data-rm")));
  });

  // lineup selectors
  lineupDiv.innerHTML = "";
  for (let z=1; z<=6; z++){
    const opts = roster.map(p => `<option value="${escapeAttr(p.id)}">${escapeHtml(formatPlayerShort(p))} ‚Ä¢ ${escapeHtml(p.role)} ‚Ä¢ (S${p.spk}/R${p.rcv})</option>`).join("");
    const selVal = lineup[z] || "";
    const zoneName = `${z} ‚Äî ${ZONES[z].short}`;
    const zoneDesc = ZONES[z].name;

    const div = document.createElement("div");
    div.className = "slot";
    div.innerHTML = `
      <div>
        <b>${zoneName}</b>
        <small>${escapeHtml(zoneDesc)}</small>
      </div>
      <div>
        <select data-zone="${z}" aria-label="Select player for zone ${z}">
          <option value="">‚Äî Select player ‚Äî</option>
          ${opts}
        </select>
      </div>
    `;
    lineupDiv.appendChild(div);

    const sel = div.querySelector("select");
    sel.value = selVal;

    sel.addEventListener("change", ()=>{
      state.teams[team].lineup[z] = sel.value || null;
      if (state.teams[team].lineup[z] && !getPlayer(team, state.teams[team].lineup[z])) state.teams[team].lineup[z] = null;
      updateTeamWarnings(team);
      updateMyWarnings();
      updateCourt();
      renderCoach();
      renderMyInsights();
      renderMyCourtPreview();
    });
  }

  updateMyWarnings();
}

function renderMyInsights(){
  const box = document.getElementById("myInsights");
  if (!box) return;
  const team = getMyTeam();
  const issues = validateLineup(team);

  if (issues.length){
    box.innerHTML = `<div class="notice show">Assign 6 unique players to zones to see insights.</div>`;
    return;
  }

  const t = state.teams[team];
  const byZone = {};
  for (let z=1; z<=6; z++){
    byZone[z] = getPlayer(team, t.lineup[z]);
  }

  const players = Object.values(byZone);
  const avgSpk = Math.round(players.reduce((s,p)=>s+p.spk,0) / 6 * 10) / 10;
  const avgRcv = Math.round(players.reduce((s,p)=>s+p.rcv,0) / 6 * 10) / 10;
  const total = players.reduce((s,p)=>s+p.total,0);

  const front = [2,3,4].map(z => formatPlayerShort(byZone[z]));
  const back  = [1,6,5].map(z => formatPlayerShort(byZone[z]));

  const serveOrder = [1,2,3,4,5,6].map(z => formatPlayerShort(byZone[z]));

  box.innerHTML = `
    <div class="step" style="margin-bottom:12px;">
      <b>Strength snapshot</b>
      <p><span class="tag">Avg Spk</span> <b>${avgSpk}</b> &nbsp; <span class="tag">Avg Rcv</span> <b>${avgRcv}</b> &nbsp; <span class="tag">Total</span> <b>${total}</b></p>
    </div>

    <div class="step" style="margin-bottom:12px;">
      <b>Front row (2‚Äì3‚Äì4)</b>
      <p>${front.map(escapeHtml).join(" ‚Ä¢ ")}</p>
      <div style="height:10px;"></div>
      <b>Back row (1‚Äì6‚Äì5)</b>
      <p>${back.map(escapeHtml).join(" ‚Ä¢ ")}</p>
    </div>

    <div class="step">
      <b>Serve order</b>
      <p class="hint">Serve order is simply the player in Zone 1, then Zone 2, 3, 4, 5, 6 as you rotate.</p>
      <ol class="events" style="margin:0; padding-left:18px;">
        ${serveOrder.map(n=>`<li>${escapeHtml(n)}</li>`).join("")}
      </ol>
    </div>
  `;
}


function renderMyCourtPreview(){
  const court = document.getElementById("myCourtPreview");
  if (!court) return;

  const team = getMyTeam();
  court.classList.toggle("myA", team === "A");
  court.classList.toggle("myB", team === "B");

  const t = state.teams[team];
  const rot = t.rot || 0;

  const playerInZone = (zone)=>{
    for (let slot=1; slot<=6; slot++){
      if (applyRotation(slot, rot) === zone){
        return getPlayer(team, t.lineup[slot]);
      }
    }
    return null;
  };

  const zones = [4,3,2,5,6,1];
  zones.forEach(z=>{
    const token = document.getElementById(`lc-token-${z}`);
    const nameEl = document.getElementById(`lc-name-${z}`);
    const roleEl = document.getElementById(`lc-role-${z}`);
    if (!token || !nameEl || !roleEl) return;

    const p = playerInZone(z);
    if (!p){
      token.classList.add("empty");
      nameEl.textContent = "‚Äî Empty";
      roleEl.textContent = (z === 1) ? "Server zone" : "Pick a player";
    } else {
      token.classList.remove("empty");
      nameEl.textContent = formatPlayerShort(p);
      roleEl.textContent = p.role;
    }
    token.classList.toggle("lcServing", z === 1);
  });

  // rotation label
  const rotLbl = document.getElementById("myRotLabel");
  if (rotLbl) rotLbl.textContent = String((t.rot || 0) + 1);
}

function optimizeLineup(team){
  const roster = state.teams[team].roster;
  if (roster.length < 6){
    showWarn("warnMy", `Need at least 6 players on Team ${team}.`);
    return;
  }

  const used = new Set();
  const pick = (cands) => {
    for (const p of cands){
      if (!used.has(p.id)){
        used.add(p.id);
        return p;
      }
    }
    return null;
  };

  const bestTotal = [...roster].sort((a,b)=> b.total - a.total);
  const bestSpk   = [...roster].sort((a,b)=> b.spk - a.spk);
  const bestRcv   = [...roster].sort((a,b)=> b.rcv - a.rcv);

  const setters = roster.filter(p=>p.role==="S").sort((a,b)=> (b.rcv + b.spk) - (a.rcv + a.spk));
  const opps    = roster.filter(p=>p.role==="OPP").sort((a,b)=> b.spk - a.spk);
  const middles = roster.filter(p=>p.role==="MB").sort((a,b)=> b.spk - a.spk);
  const outsides= roster.filter(p=>p.role==="OH").sort((a,b)=> (b.rcv*1.2 + b.spk) - (a.rcv*1.2 + a.spk));
  const libs    = roster.filter(p=>p.role==="L" || p.role==="DS").sort((a,b)=> b.rcv - a.rcv);

  // Role-first picks (simple 5‚Äì1 style)
  const S   = pick(setters.length ? setters : bestRcv);
  const OPP = pick(opps.length ? opps : bestSpk);
  const MB1 = pick(middles.length ? middles : bestSpk);
  const OH1 = pick(outsides.length ? outsides : bestTotal);
  const L   = pick(libs.length ? libs : bestRcv);
  const MB2 = pick(middles.length ? middles : bestTotal);

  // Fill any missing slots with remaining best
  const zones = {1:S, 2:OPP, 3:MB1, 4:OH1, 5:L, 6:MB2};
  const remaining = bestTotal.filter(p=>!used.has(p.id));
  for (let z=1; z<=6; z++){
    if (!zones[z]){
      zones[z] = remaining.shift() || null;
    }
  }

  // Apply
  for (let z=1; z<=6; z++) state.teams[team].lineup[z] = zones[z] ? zones[z].id : null;
  state.teams[team].rot = 0;
  state.teams[team].history = [];

  renderLineups();
  renderMyLineup();
  renderMyInsights();
  renderMyCourtPreview();
  updateCourt();
  renderCoach();

  showWarn("warnMy", "");
}
function renderScore(){
  document.getElementById("score-a-display").textContent = String(state.game.scoreA);
  document.getElementById("score-b-display").textContent = String(state.game.scoreB);

  const team = state.game.serverTeam;
  document.getElementById("serve-team").textContent = team;
  document.getElementById("serve-player").textContent = getServerName(team);
}

function getServerSlot(team){
  const rot = state.teams[team].rot;
  for (let slot=1; slot<=6; slot++){
    const zone = applyRotation(slot, rot);
    if (zone === 1) return slot;
  }
  return 1;
}
function getServerName(team){
  const slot = getServerSlot(team);
  const pid = state.teams[team].lineup[slot];
  const p = getPlayer(team, pid);
  return p ? formatPlayerShort(p) : "‚Äî";
}

function renderTeamMeta(){
  document.getElementById("rotA").textContent = String((state.teams.A.rot % 6) + 1);
  document.getElementById("rotB").textContent = String((state.teams.B.rot % 6) + 1);
  document.getElementById("serverA").textContent = getServerName("A");
  document.getElementById("serverB").textContent = getServerName("B");
}

function renderZoneLabels(){
  const wrap = document.getElementById("zoneLabels");
  wrap.innerHTML = "";
  if (!state.ui.showZones) return;

  // Add 6 for each team side using that team's coordinate mapping
  ["A","B"].forEach(team=>{
    for (let z=1; z<=6; z++){
      const c = coordsFor(team, z);
      const label = document.createElement("div");
      label.className = "zone-label";
      label.style.left = c.left;
      label.style.top = c.top;
      label.innerHTML = `<div class="zoneChip">${team}${z} ${ZONES[z].short}</div>`;
      wrap.appendChild(label);
    }
  });
}

function updateCourt(){
  const court = document.getElementById("court");
  court.classList.toggle("tokenRoleOn", !!state.ui.showRoles);

  renderZoneLabels();

  ["A","B"].forEach(team=>{
    const t = state.teams[team];
    const rot = t.rot;
    const isServingTeam = state.game.serverTeam === team;

    for (let slot=1; slot<=6; slot++){
      const pid = t.lineup[slot];
      const token = document.getElementById(`${team.toLowerCase()}-token-${slot}`);
      const nameEl = document.getElementById(`${team.toLowerCase()}-name-${slot}`);
      const jerseyEl = document.getElementById(`${team.toLowerCase()}-jersey-${slot}`);
      const roleEl = document.getElementById(`${team.toLowerCase()}-role-${slot}`);

      if (!pid){
        token.style.display = "none";
        token.classList.remove("is-serving");
        continue;
      }
      const p = getPlayer(team, pid);
      if (!p){
        token.style.display = "none";
        token.classList.remove("is-serving");
        continue;
      }

      const currentZone = applyRotation(slot, rot);
      const c = coordsFor(team, currentZone);

      token.style.display = "flex";
      token.style.left = c.left;
      token.style.top = c.top;

      jerseyEl.textContent = (p.jersey ? `#${p.jersey}` : "");
      nameEl.textContent = p.name || "Unnamed";
      roleEl.textContent = p.role || "";

      token.classList.toggle("is-serving", isServingTeam && currentZone === 1);
    }
  });

  renderTeamMeta();
  renderScore();
}

/* =====================================================
   Roster management
===================================================== */
function addPlayer(team){
  const name = (document.getElementById(`name-${team.toLowerCase()}`).value || "").trim();
  const jersey = (document.getElementById(`jersey-${team.toLowerCase()}`).value || "").trim();
  const role = document.getElementById(`role-${team.toLowerCase()}`).value;
  const spk = clampInt(document.getElementById(`spk-${team.toLowerCase()}`).value, 1, 10, 5);
  const rcv = clampInt(document.getElementById(`rcv-${team.toLowerCase()}`).value, 1, 10, 5);

  if (!name) return;

  state.teams[team].roster.push(makePlayer({name, jersey, role, spk, rcv}));

  document.getElementById(`name-${team.toLowerCase()}`).value = "";
  document.getElementById(`jersey-${team.toLowerCase()}`).value = "";
  document.getElementById(`spk-${team.toLowerCase()}`).value = 5;
  document.getElementById(`rcv-${team.toLowerCase()}`).value = 5;

  renderRosters();
}

function removePlayer(team, id){
  state.teams[team].roster = state.teams[team].roster.filter(p => p.id !== id);

  // Remove from lineup if assigned
  for (let z=1; z<=6; z++){
    if (state.teams[team].lineup[z] === id) state.teams[team].lineup[z] = null;
  }
  renderRosters();
  updateTeamWarnings(team);
  updateCourt();
  renderCoach();
  if (document.getElementById("roster-my") && team === getMyTeam()){
    renderMyLineup();
    renderMyInsights();
    renderMyCourtPreview();
  }
}

function clearLineup(team){
  for (let z=1; z<=6; z++) state.teams[team].lineup[z] = null;
  state.teams[team].rot = 0;
  state.teams[team].history = [];
  renderLineups();
  updateCourt();
  renderCoach();
  if (document.getElementById("myCourtPreview") && team === getMyTeam()){
    updateMyWarnings();
    renderMyCourtPreview();
    renderMyInsights();
  }
}

function autoLineup(team){
  const roster = state.teams[team].roster;
  if (roster.length < 6){
    const msg = `Need at least 6 players on Team ${team}.`;
    showWarn(team==="A" ? "warnA" : "warnB", msg);
    if (document.getElementById("warnMy") && team === getMyTeam()) showWarn("warnMy", msg);
    updateSimWarnings();
    return;
  }

  const top6 = [...roster].sort((a,b)=> (b.total - a.total)).slice(0,6);
  // Gemini-style quick assignment: 4,3,2 / 5,6,1
  const t = state.teams[team];
  t.lineup[4] = top6[0].id;
  t.lineup[3] = top6[1].id;
  t.lineup[2] = top6[2].id;
  t.lineup[5] = top6[3].id;
  t.lineup[6] = top6[4].id;
  t.lineup[1] = top6[5].id;

  t.rot = 0;
  t.history = [];

  renderLineups();
  updateCourt();
  renderCoach();
  if (document.getElementById("roster-my") && team === getMyTeam()){
    renderMyLineup();
    renderMyInsights();
    renderMyCourtPreview();
  }

  showWarn(team==="A" ? "warnA" : "warnB", "");
}

/* =====================================================
   Rotation controls (manual)
===================================================== */
function rotateTeam(team){
  const issues = validateLineup(team);
  if (issues.length){
    const msg = issues.join("\n");
    showWarn(team==="A" ? "warnA" : "warnB", msg);
    if (document.getElementById("warnMy") && team === getMyTeam()) showWarn("warnMy", msg);
    updateSimWarnings();
    return;
  }
  const t = state.teams[team];
  t.history.push(t.rot);
  t.rot = (t.rot + 1) % 6;
  updateCourt();
  renderCoach();
  if (document.getElementById("myCourtPreview") && team === getMyTeam()){
    updateMyWarnings();
    renderMyCourtPreview();
    renderMyInsights();
  }
}
function undoRotateTeam(team){
  const t = state.teams[team];
  if (!t.history.length) return;
  t.rot = t.history.pop();
  updateCourt();
  renderCoach();
  if (document.getElementById("myCourtPreview") && team === getMyTeam()){
    updateMyWarnings();
    renderMyCourtPreview();
    renderMyInsights();
  }
}
function resetRotateTeam(team){
  const t = state.teams[team];
  t.rot = 0;
  t.history = [];
  updateCourt();
  renderCoach();
  if (document.getElementById("myCourtPreview") && team === getMyTeam()){
    updateMyWarnings();
    renderMyCourtPreview();
    renderMyInsights();
  }
}

/* =====================================================
   Simulation
===================================================== */
async function startSimulation(){
  if (state.game.simActive) return;

  const aIssues = validateLineup("A");
  const bIssues = validateLineup("B");
  if (aIssues.length || bIssues.length){
    showWarn("warnA", aIssues.join("\n"));
    showWarn("warnB", bIssues.join("\n"));
    updateSimWarnings();
    return;
  }
  showWarn("simWarn", "");

  state.settings.targetPoints = clampInt(document.getElementById("targetPoints").value, 1, 99, 15);
  state.settings.speed = Number(document.getElementById("speed").value) || 1;

  state.game.simActive = true;
  state.game.scoreA = 0;
  state.game.scoreB = 0;
  state.game.serverTeam = state.game.serverTeam || "A";
  state.game.events = [];
  setStatus("Match in Progress...");

  document.getElementById("btn-sim").disabled = true;
  document.getElementById("btn-stop").disabled = false;

  pushEvent("Match started. Rally scoring enabled.");

  renderScore();
  updateCourt();

  while (state.game.simActive && !isGameOver()){
    await playRally();
  }

  if (!state.game.simActive){
    setStatus("Stopped");
    document.getElementById("btn-sim").disabled = false;
    return;
  }

  const winner = state.game.scoreA > state.game.scoreB ? "TEAM A WINS!" : "TEAM B WINS!";
  setStatus(winner);
  pushEvent(winner);

  state.game.simActive = false;
  document.getElementById("btn-sim").disabled = false;
  document.getElementById("btn-stop").disabled = true;
}

function stopSimulation(){
  state.game.simActive = false;
  document.getElementById("btn-stop").disabled = true;
  document.getElementById("btn-sim").disabled = false;
  setStatus("Stopped");
}

function resetMatch(){
  stopSimulation();
  state.game.scoreA = 0;
  state.game.scoreB = 0;
  state.game.serverTeam = "A";
  state.game.events = [];
  setStatus("Waiting to start");
  renderScore();
  updateCourt();
  renderEvents();
}

function isGameOver(){
  const t = state.settings.targetPoints;
  const a = state.game.scoreA, b = state.game.scoreB;
  if (a < t && b < t) return false;
  return Math.abs(a - b) >= 2;
}

async function playRally(){
  const ball = document.getElementById("ball");
  const speed = state.settings.speed;

  const serverTeam = state.game.serverTeam;
  const receiverTeam = otherTeam(serverTeam);

  const powerA = lineupPlayers("A").reduce((sum,p)=> sum + p.spk + p.rcv, 0);
  const powerB = lineupPlayers("B").reduce((sum,p)=> sum + p.spk + p.rcv, 0);

  // slight randomness
  let chanceA = (powerA / (powerA + powerB)) + (Math.random() * 0.20 - 0.10);
  chanceA = Math.max(0.05, Math.min(0.95, chanceA));

  const winnerTeam = (Math.random() < chanceA) ? "A" : "B";

  // Ball animation
  ball.classList.add("ball-active");
  const start = coordsFor(serverTeam, 1);
  ball.style.left = start.left;
  ball.style.top = start.top;
  await wait(160 * speed);

  const touches = Math.floor(Math.random() * 3) + 3; // 3-5
  for (let i=0; i<touches; i++){
    const toTeam = (i % 2 === 0) ? receiverTeam : serverTeam;
    ball.classList.add("ball-smash");
    // keep within half
    if (toTeam === "B"){
      ball.style.top = `${Math.floor(Math.random() * 30) + 10}%`;
    } else {
      ball.style.top = `${Math.floor(Math.random() * 30) + 60}%`;
    }
    ball.style.left = `${Math.floor(Math.random() * 80) + 10}%`;

    await wait(140 * speed);
    ball.classList.remove("ball-smash");
    await wait(360 * speed);
  }

  // Final smash toward winner side
  ball.classList.add("ball-smash");
  if (winnerTeam === "B"){
    ball.style.top = `${Math.floor(Math.random() * 30) + 10}%`;
  } else {
    ball.style.top = `${Math.floor(Math.random() * 30) + 60}%`;
  }
  ball.style.left = `${Math.floor(Math.random() * 80) + 10}%`;
  await wait(220 * speed);

  ball.classList.remove("ball-smash");
  ball.classList.remove("ball-active");

  // Scoring: rally scoring
  if (winnerTeam === "A") state.game.scoreA++;
  else state.game.scoreB++;

  // Side-out rotation: if receiver wins, receiver rotates and gains serve
  const sideOut = (winnerTeam !== serverTeam);
  if (sideOut){
    state.teams[winnerTeam].rot = (state.teams[winnerTeam].rot + 1) % 6;
    state.game.serverTeam = winnerTeam;
    pushEvent(`Side-out: Team ${winnerTeam} won, rotates, and serves next.`);
  } else {
    pushEvent(`Team ${winnerTeam} won the rally (serve held).`);
  }

  renderScore();
  updateCourt();

  await wait(180 * speed);
}

/* =====================================================
   Save / Load JSON (V5-style)
===================================================== */
function exportJson(){
  const payload = {
    version: state.version,
    theme: document.documentElement.getAttribute("data-theme") || "dark",
    ui: state.ui,
    settings: state.settings,
    game: {
      scoreA: state.game.scoreA,
      scoreB: state.game.scoreB,
      serverTeam: state.game.serverTeam,
      status: state.game.status,
    },
    teams: {
      A: {
        rot: state.teams.A.rot,
        roster: state.teams.A.roster,
        lineup: state.teams.A.lineup,
      },
      B: {
        rot: state.teams.B.rot,
        roster: state.teams.B.roster,
        lineup: state.teams.B.lineup,
      }
    }
  };
  return JSON.stringify(payload, null, 2);
}

function importJson(raw){
  let obj;
  try{ obj = JSON.parse(raw); }
  catch(e){ throw new Error("Invalid JSON: unable to parse."); }
  if (!obj || typeof obj !== "object") throw new Error("Invalid JSON: expected an object.");

  // minimal shape validation
  if (!obj.teams || !obj.teams.A || !obj.teams.B) throw new Error("Invalid JSON: missing teams A/B.");
  if (!obj.teams.A.roster || !obj.teams.B.roster) throw new Error("Invalid JSON: missing rosters.");

  const normalizeTeam = (src)=>{
    const roster = Array.isArray(src.roster) ? src.roster : [];
    const rosterNorm = roster.map(p => ({
      id: (p.id && typeof p.id === "string") ? p.id : uid(),
      name: String(p.name ?? "").trim(),
      jersey: String(p.jersey ?? "").trim(),
      role: String(p.role ?? "OH"),
      spk: clampInt(p.spk, 1, 10, 5),
      rcv: clampInt(p.rcv, 1, 10, 5),
      total: clampInt((p.spk ?? 5), 1, 10, 5) + clampInt((p.rcv ?? 5), 1, 10, 5),
    }));
    const lineup = src.lineup && typeof src.lineup === "object" ? src.lineup : {};
    const lineupNorm = {1:null,2:null,3:null,4:null,5:null,6:null};
    for (let z=1; z<=6; z++){
      const v = lineup[z];
      lineupNorm[z] = (typeof v === "string" && v.trim()) ? v : null;
    }
    let rot = Number(src.rot) || 0;
    rot = ((rot % 6) + 6) % 6;
    return { roster: rosterNorm, lineup: lineupNorm, rot, history: [] };
  };

  state.ui = obj.ui && typeof obj.ui === "object" ? { showZones: !!obj.ui.showZones, showRoles: !!obj.ui.showRoles } : state.ui;
  state.settings = obj.settings && typeof obj.settings === "object"
    ? { targetPoints: clampInt(obj.settings.targetPoints, 1, 99, 15), speed: Number(obj.settings.speed) || 1 }
    : state.settings;

  state.teams.A = normalizeTeam(obj.teams.A);
  state.teams.B = normalizeTeam(obj.teams.B);

  state.game.scoreA = clampInt(obj.game?.scoreA, 0, 999, 0);
  state.game.scoreB = clampInt(obj.game?.scoreB, 0, 999, 0);
  state.game.serverTeam = (obj.game?.serverTeam === "B") ? "B" : "A";
  state.game.simActive = false;
  state.game.events = [];
  setStatus(String(obj.game?.status ?? "Waiting to start"));

  // theme from payload (optional)
  if (obj.theme === "light" || obj.theme === "dark") setTheme(obj.theme);

  // reflect settings into UI controls
  document.getElementById("toggleZones").checked = state.ui.showZones;
  document.getElementById("toggleRoles").checked = state.ui.showRoles;
  document.getElementById("targetPoints").value = state.settings.targetPoints;
  document.getElementById("speed").value = String(state.settings.speed);

  renderRosters();
  renderLineups();
  renderScore();
  updateCourt();
  renderCoach();

  // warn if lineups invalid (still load)
  const aIssues = validateLineup("A");
  const bIssues = validateLineup("B");
  if (aIssues.length || bIssues.length){
    showErr("Loaded, but there are lineup issues:\n" + [...aIssues.map(x=>"A: "+x), ...bIssues.map(x=>"B: "+x)].join("\n"));
  } else {
    showOk("Loaded successfully.");
  }
}

/* =====================================================
   Coach sheet
===================================================== */
function renderCoach(){
  const team = state.coach.team;
  const grid = document.getElementById("coachGrid");
  const warn = document.getElementById("coachWarn");

  const issues = validateLineup(team);
  if (issues.length){
    warn.classList.add("show");
    warn.textContent = `Team ${team} has lineup issues:\n` + issues.join("\n");
    grid.innerHTML = "";
    return;
  }
  warn.classList.remove("show");
  warn.textContent = "";

  const baseRot = state.teams[team].rot;

  const rotations = [];
  for (let r=0; r<6; r++){
    const rot = (baseRot + r) % 6;
    const rotNum = rot + 1;

    // Build zone -> player mapping for this rotation
    const zoneToPlayer = {};
    let serverZonePlayer = null;

    for (let slot=1; slot<=6; slot++){
      const pid = state.teams[team].lineup[slot];
      const p = getPlayer(team, pid);
      const zoneNow = applyRotation(slot, rot);
      zoneToPlayer[zoneNow] = p;
      if (zoneNow === 1) serverZonePlayer = p;
    }

    rotations.push({ rotNum, zoneToPlayer, server: serverZonePlayer });
  }

  // zone order in mini grid: 4 3 2 / 5 6 1
  const miniOrder = [4,3,2,5,6,1];

  grid.innerHTML = rotations.map(item=>{
    const serverName = item.server ? formatPlayerShort(item.server) : "‚Äî";
    return `
      <div class="miniRotation">
        <div class="miniHead">
          <div>
            <b>Rotation ${item.rotNum}</b>
            <small>Server: ${escapeHtml(serverName)}</small>
          </div>
          <span class="pill">Team ${team}</span>
        </div>
        <div class="miniCourt">
          <div class="miniGrid">
            ${miniOrder.map(z=>{
              const p = item.zoneToPlayer[z] || null;
              const nm = p ? formatPlayerShort(p) : "‚Äî";
              const rl = p ? (p.role || "") : "";
              const serveClass = (z===1) ? "mServe" : "";
              return `
                <div class="mZone ${serveClass}">
                  <div class="mLabel"><span class="chip">${z}</span> ${ZONES[z].short}</div>
                  <div class="mName">${escapeHtml(nm)}</div>
                  <div class="mRole">${escapeHtml(rl)}</div>
                </div>
              `;
            }).join("")}
          </div>
        </div>
      </div>
    `;
  }).join("");
}

/* =====================================================
   Tabs + wiring
===================================================== */
const TAB_KEY = "vb_active_tab_v7";

function setTab(which, opts={scroll:true}){
  const tabs = [
    {key:"home",   tab:"tabHome",   view:"viewHome"},
    {key:"lineup", tab:"tabLineup", view:"viewLineup"},
    {key:"sim",    tab:"tabSim",    view:"viewSim"},
    {key:"coach",  tab:"tabCoach",  view:"viewCoach"},
    {key:"rules",  tab:"tabRules",  view:"viewRules"},
  ];

  tabs.forEach(t=>{
    const viewEl = document.getElementById(t.view);
    const tabEl  = document.getElementById(t.tab);
    if (!viewEl || !tabEl) return;
    const active = (t.key === which);
    viewEl.classList.toggle("hidden", !active);
    tabEl.setAttribute("aria-selected", active ? "true" : "false");
  });

  state.ui.activeTab = which;
  try{ localStorage.setItem(TAB_KEY, which); }catch(e){}

  if (which === "coach") renderCoach();
  if (which === "lineup"){ renderMyLineup(); renderMyInsights(); renderMyCourtPreview(); }
  if (which === "sim"){ updateSimWarnings(); renderScore(); updateCourt(); }
  if (opts.scroll) window.scrollTo({top:0, behavior:"smooth"});
}
function renderEvents(){
  const ul = document.getElementById("events");
  ul.innerHTML = (state.game.events.length ? state.game.events : ["‚Äî"]).map(e=>`<li>${escapeHtml(e)}</li>`).join("");
}

/* =====================================================
   Safe escaping for rendering
===================================================== */
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, ch => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[ch]));
}
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }

/* =====================================================
   Init
===================================================== */
function init(){
  // theme
  setTheme(getPreferredTheme());
  document.getElementById("themeToggle").addEventListener("click", ()=>{
    const cur = document.documentElement.getAttribute("data-theme") || "dark";
    setTheme(cur === "dark" ? "light" : "dark");
  });

  // load demo rosters (Gemini base idea)
  state.teams.A.roster = DEFAULTS.A.map(makePlayer);
  state.teams.B.roster = DEFAULTS.B.map(makePlayer);

  // toggles
  document.getElementById("toggleZones").addEventListener("change", (e)=>{
    state.ui.showZones = !!e.target.checked;
    updateCourt();
  });
  document.getElementById("toggleRoles").addEventListener("change", (e)=>{
    state.ui.showRoles = !!e.target.checked;
    updateCourt();
  });

  // buttons: add players
  document.getElementById("btnAddA").addEventListener("click", ()=>addPlayer("A"));
  document.getElementById("btnAddB").addEventListener("click", ()=>addPlayer("B"));
  document.getElementById("btnAutoA").addEventListener("click", ()=>autoLineup("A"));
  document.getElementById("btnAutoB").addEventListener("click", ()=>autoLineup("B"));
  document.getElementById("btnClearA").addEventListener("click", ()=>clearLineup("A"));
  document.getElementById("btnClearB").addEventListener("click", ()=>clearLineup("B"));

  // manual rotations
  document.getElementById("btnRotateA").addEventListener("click", ()=>rotateTeam("A"));
  document.getElementById("btnUndoA").addEventListener("click", ()=>undoRotateTeam("A"));
  document.getElementById("btnResetA").addEventListener("click", ()=>resetRotateTeam("A"));

  document.getElementById("btnRotateB").addEventListener("click", ()=>rotateTeam("B"));
  document.getElementById("btnUndoB").addEventListener("click", ()=>undoRotateTeam("B"));
  document.getElementById("btnResetB").addEventListener("click", ()=>resetRotateTeam("B"));

  // sim
  document.getElementById("btn-sim").addEventListener("click", startSimulation);
  document.getElementById("btn-stop").addEventListener("click", stopSimulation);
  document.getElementById("btn-reset-match").addEventListener("click", resetMatch);
  document.getElementById("btn-stop").disabled = true;

  // settings reflect state
  document.getElementById("targetPoints").value = state.settings.targetPoints;
  document.getElementById("speed").value = String(state.settings.speed);

  // save/load
  document.getElementById("btnCopyJson").addEventListener("click", ()=>copyToClipboard(exportJson()));
  document.getElementById("btnLoadJson").addEventListener("click", ()=>{
    try{
      importJson(document.getElementById("jsonBox").value || "");
    }catch(e){
      showErr(e.message || "Failed to load JSON.");
    }
  });

  // tabs
  document.getElementById("tabHome").addEventListener("click", ()=>setTab("home"));
  document.getElementById("tabLineup").addEventListener("click", ()=>setTab("lineup"));
  document.getElementById("tabSim").addEventListener("click", ()=>setTab("sim"));
  document.getElementById("tabCoach").addEventListener("click", ()=>setTab("coach"));
  document.getElementById("tabRules").addEventListener("click", ()=>setTab("rules"));

  // cross-nav buttons
  document.getElementById("goLineup").addEventListener("click", ()=>setTab("lineup"));
  document.getElementById("goSim").addEventListener("click", ()=>setTab("sim"));
  document.getElementById("simGoHome").addEventListener("click", ()=>setTab("home"));
  document.getElementById("lineupGoHome").addEventListener("click", ()=>setTab("home"));
  document.getElementById("lineupGoSim").addEventListener("click", ()=>setTab("sim"));
  document.getElementById("rulesGoHome").addEventListener("click", ()=>setTab("home"));

  // lineup builder (my team)
  document.getElementById("myTeamA").addEventListener("click", ()=>setMyTeam("A"));
  document.getElementById("myTeamB").addEventListener("click", ()=>setMyTeam("B"));
  document.getElementById("btnMyAdd").addEventListener("click", addMyPlayer);
  document.getElementById("btnMyAuto").addEventListener("click", ()=>autoLineup(getMyTeam()));
  document.getElementById("btnMyOptimize").addEventListener("click", ()=>optimizeLineup(getMyTeam()));
  document.getElementById("btnMyClear").addEventListener("click", ()=>clearLineup(getMyTeam()));
  document.getElementById("btnMyRotate").addEventListener("click", ()=>rotateTeam(getMyTeam()));
  document.getElementById("btnMyUndo").addEventListener("click", ()=>undoRotateTeam(getMyTeam()));
  document.getElementById("btnMyReset").addEventListener("click", ()=>resetRotateTeam(getMyTeam()));

  // allow Enter-to-add in lineup builder name field
  document.getElementById("my-name").addEventListener("keydown", (e)=>{
    if (e.key === "Enter"){ e.preventDefault(); addMyPlayer(); }
  });

  // initial tab (persisted)
  const savedTab = localStorage.getItem(TAB_KEY);
  if (savedTab) setTab(savedTab, {scroll:false});
// coach team selector
  const coachA = document.getElementById("coachTeamA");
  const coachB = document.getElementById("coachTeamB");
  coachA.addEventListener("click", ()=>{
    state.coach.team = "A";
    coachA.setAttribute("aria-selected","true");
    coachB.setAttribute("aria-selected","false");
    renderCoach();
  });
  coachB.addEventListener("click", ()=>{
    state.coach.team = "B";
    coachA.setAttribute("aria-selected","false");
    coachB.setAttribute("aria-selected","true");
    renderCoach();
  });

  document.getElementById("btnPrint").addEventListener("click", ()=>window.print());

  // initial render
  renderRosters();
  renderLineups();
  renderScore();
  renderEvents();
  updateCourt();
  renderCoach();
  setMyTeam(getMyTeam());
  updateSimWarnings();
}
init();
</script>
</body>
</html>